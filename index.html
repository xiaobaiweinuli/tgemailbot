<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gmail Telegram Bot - Cloudflare Worker éƒ¨ç½²æŒ‡å—</title>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
  <style>
    .gradient-bg {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .code-container {
      max-height: 600px;
      overflow-y: auto;
    }
    pre[class*="language-"] {
      margin: 0;
      border-radius: 0.5rem;
    }
    .step-number {
      width: 32px;
      height: 32px;
      min-width: 32px;
    }
    .copy-btn:active {
      transform: scale(0.95);
    }
  </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
  <!-- Header -->
  <header class="gradient-bg py-12 px-4">
    <div class="max-w-5xl mx-auto text-center">
      <div class="flex items-center justify-center gap-4 mb-4">
        <span class="text-5xl">ğŸ“§</span>
        <span class="text-5xl">ğŸ¤–</span>
      </div>
      <h1 class="text-4xl md:text-5xl font-bold mb-4">Gmail Telegram Bot</h1>
      <p class="text-xl text-purple-100 max-w-2xl mx-auto">
        åŸºäº Cloudflare Workers çš„ Telegram Botï¼Œå®‰å…¨è®¿é—® Gmail é‚®ç®±ï¼Œæ”¯æŒå®æ—¶æ¨é€
      </p>
      <div class="flex flex-wrap justify-center gap-3 mt-6">
        <span class="bg-white/20 px-3 py-1 rounded-full text-sm">âœ¨ å®Œå…¨å…è´¹</span>
        <span class="bg-white/20 px-3 py-1 rounded-full text-sm">ğŸ”’ OAuth å®‰å…¨è®¤è¯</span>
        <span class="bg-white/20 px-3 py-1 rounded-full text-sm">ğŸ”” å®æ—¶æ¨é€</span>
        <span class="bg-white/20 px-3 py-1 rounded-full text-sm">ğŸ‘¥ å¤šè´¦æˆ·æ”¯æŒ</span>
      </div>
    </div>
  </header>

  <main class="max-w-5xl mx-auto px-4 py-12">
    <!-- Features -->
    <section class="mb-16">
      <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
        <span class="text-purple-400">ğŸš€</span> åŠŸèƒ½ç‰¹æ€§
      </h2>
      <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
        <div class="bg-gray-800 rounded-xl p-5 border border-gray-700 hover:border-purple-500 transition">
          <div class="text-2xl mb-2">ğŸ‘¥</div>
          <h3 class="font-semibold mb-1">å¤šè´¦æˆ·ç®¡ç†</h3>
          <p class="text-gray-400 text-sm">æ”¯æŒç»‘å®šå¤šä¸ª Gmail è´¦å·ï¼Œä¸€é”®åˆ‡æ¢</p>
        </div>
        <div class="bg-gray-800 rounded-xl p-5 border border-gray-700 hover:border-purple-500 transition">
          <div class="text-2xl mb-2">ğŸ””</div>
          <h3 class="font-semibold mb-1">å®æ—¶æ¨é€</h3>
          <p class="text-gray-400 text-sm">é€šè¿‡ Pub/Sub å®ç°æ–°é‚®ä»¶å®æ—¶é€šçŸ¥</p>
        </div>
        <div class="bg-gray-800 rounded-xl p-5 border border-gray-700 hover:border-purple-500 transition">
          <div class="text-2xl mb-2">ğŸ“¬</div>
          <h3 class="font-semibold mb-1">åˆ†é¡µæµè§ˆé‚®ä»¶</h3>
          <p class="text-gray-400 text-sm">ä¸Šä¸€é¡µ/ä¸‹ä¸€é¡µç¿»é¡µï¼Œæ¯é¡µ5å°é‚®ä»¶</p>
        </div>
        <div class="bg-gray-800 rounded-xl p-5 border border-gray-700 hover:border-purple-500 transition">
          <div class="text-2xl mb-2">ğŸ”</div>
          <h3 class="font-semibold mb-1">æ™ºèƒ½æœç´¢</h3>
          <p class="text-gray-400 text-sm">æ”¯æŒ Gmail æœç´¢è¯­æ³•ï¼Œå¿«æ·æŒ‰é’®</p>
        </div>
        <div class="bg-gray-800 rounded-xl p-5 border border-gray-700 hover:border-purple-500 transition">
          <div class="text-2xl mb-2">ğŸ“Š</div>
          <h3 class="font-semibold mb-1">é‚®ç®±ç»Ÿè®¡</h3>
          <p class="text-gray-400 text-sm">æœªè¯»æ•°ã€ä»Šæ—¥é‚®ä»¶ã€æ˜Ÿæ ‡æ•°é‡ç»Ÿè®¡</p>
        </div>
        <div class="bg-gray-800 rounded-xl p-5 border border-gray-700 hover:border-purple-500 transition">
          <div class="text-2xl mb-2">ğŸ“</div>
          <h3 class="font-semibold mb-1">é™„ä»¶ä¸‹è½½</h3>
          <p class="text-gray-400 text-sm">ç›´æ¥ä¸‹è½½é™„ä»¶åˆ° Telegramï¼ˆâ‰¤20MBï¼‰</p>
        </div>
        <div class="bg-gray-800 rounded-xl p-5 border border-gray-700 hover:border-purple-500 transition">
          <div class="text-2xl mb-2">âœ…</div>
          <h3 class="font-semibold mb-1">æ‰¹é‡æ“ä½œ</h3>
          <p class="text-gray-400 text-sm">ä¸€é”®å…¨éƒ¨å·²è¯»ã€å•å°æ ‡è®°ã€åˆ é™¤</p>
        </div>
        <div class="bg-gray-800 rounded-xl p-5 border border-gray-700 hover:border-purple-500 transition">
          <div class="text-2xl mb-2">ğŸ‘¤</div>
          <h3 class="font-semibold mb-1">å‘ä»¶äººæœç´¢</h3>
          <p class="text-gray-400 text-sm">ç‚¹å‡»å‘ä»¶äººå¿«é€Ÿæœç´¢ TA çš„æ‰€æœ‰é‚®ä»¶</p>
        </div>
        <div class="bg-gray-800 rounded-xl p-5 border border-gray-700 hover:border-purple-500 transition">
          <div class="text-2xl mb-2">ğŸ”</div>
          <h3 class="font-semibold mb-1">å®‰å…¨è®¤è¯</h3>
          <p class="text-gray-400 text-sm">Google OAuth 2.0ï¼Œæ— éœ€æä¾›å¯†ç </p>
        </div>
      </div>
    </section>

    <!-- Button Menu -->
    <section class="mb-16">
      <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
        <span class="text-purple-400">âŒ¨ï¸</span> å¿«æ·æŒ‰é’®èœå•
      </h2>
      <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
        <p class="text-gray-300 mb-4">Bot ä½¿ç”¨è¾“å…¥æ¡†ä¸‹æ–¹çš„å¿«æ·æŒ‰é’®ï¼Œæ— éœ€è¾“å…¥å‘½ä»¤ï¼š</p>
        <div class="bg-gray-900 rounded-lg p-4 max-w-md mx-auto">
          <div class="grid grid-cols-3 gap-2 text-center text-sm">
            <div class="bg-blue-600/30 border border-blue-500/50 rounded py-2">ğŸ“¬ æ”¶ä»¶ç®±</div>
            <div class="bg-blue-600/30 border border-blue-500/50 rounded py-2">ğŸ“… ä»Šæ—¥</div>
            <div class="bg-blue-600/30 border border-blue-500/50 rounded py-2">â­ æ˜Ÿæ ‡</div>
            <div class="bg-green-600/30 border border-green-500/50 rounded py-2">ğŸ” æœç´¢</div>
            <div class="bg-green-600/30 border border-green-500/50 rounded py-2">ğŸ“Š ç»Ÿè®¡</div>
            <div class="bg-green-600/30 border border-green-500/50 rounded py-2">âœ… å…¨å·²è¯»</div>
            <div class="bg-purple-600/30 border border-purple-500/50 rounded py-2 col-span-2">ğŸ‘¤ è´¦æˆ·ç®¡ç†</div>
            <div class="bg-purple-600/30 border border-purple-500/50 rounded py-2">âš™ï¸ è®¾ç½®</div>
          </div>
        </div>
      </div>
    </section>

    <!-- Deployment Steps -->
    <section class="mb-16">
      <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
        <span class="text-purple-400">ğŸ“‹</span> éƒ¨ç½²æ­¥éª¤
      </h2>
      
      <div class="space-y-6">
        <!-- Step 1 -->
        <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
          <div class="flex gap-4">
            <div class="step-number bg-purple-600 rounded-full flex items-center justify-center font-bold shrink-0">1</div>
            <div class="flex-1">
              <h3 class="font-bold text-lg mb-2">åˆ›å»º Telegram Bot</h3>
              <ol class="list-decimal list-inside text-gray-300 space-y-1 ml-1">
                <li>åœ¨ Telegram æœç´¢ <code class="bg-gray-700 px-2 py-0.5 rounded">@BotFather</code></li>
                <li>å‘é€ <code class="bg-gray-700 px-2 py-0.5 rounded">/newbot</code> åˆ›å»ºæ–° Bot</li>
                <li>æŒ‰æç¤ºè®¾ç½®åç§°ï¼Œè·å– <code class="bg-purple-700/50 px-2 py-0.5 rounded text-purple-300">BOT_TOKEN</code></li>
              </ol>
            </div>
          </div>
        </div>

        <!-- Step 2 -->
        <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
          <div class="flex gap-4">
            <div class="step-number bg-purple-600 rounded-full flex items-center justify-center font-bold shrink-0">2</div>
            <div class="flex-1">
              <h3 class="font-bold text-lg mb-2">åˆ›å»º Google OAuth å‡­è¯</h3>
              <ol class="list-decimal list-inside text-gray-300 space-y-2 ml-1">
                <li>è®¿é—® <a href="https://console.cloud.google.com/apis/credentials" target="_blank" class="text-purple-400 hover:underline">Google Cloud Console</a></li>
                <li>åˆ›å»ºé¡¹ç›®ï¼ˆå¦‚å·²æœ‰å¯è·³è¿‡ï¼‰</li>
                <li>åˆ›å»º OAuth 2.0 å®¢æˆ·ç«¯ IDï¼ˆé€‰æ‹© Web åº”ç”¨ç±»å‹ï¼‰</li>
                <li>æ·»åŠ æˆæƒé‡å®šå‘ URIï¼š
                  <code class="block bg-gray-700 px-3 py-2 rounded mt-1 text-sm break-all">https://your-worker.your-username.workers.dev/oauth/callback</code>
                </li>
                <li>å¯ç”¨ <a href="https://console.cloud.google.com/apis/library/gmail.googleapis.com" target="_blank" class="text-purple-400 hover:underline">Gmail API</a></li>
                <li>è®°å½• <code class="bg-purple-700/50 px-2 py-0.5 rounded text-purple-300">CLIENT_ID</code> å’Œ <code class="bg-purple-700/50 px-2 py-0.5 rounded text-purple-300">CLIENT_SECRET</code></li>
              </ol>
              <div class="mt-3 p-3 bg-yellow-900/30 border border-yellow-700/50 rounded-lg text-yellow-200 text-sm">
                âš ï¸ æ³¨æ„ï¼šå¦‚æœåº”ç”¨æœªå‘å¸ƒï¼Œéœ€åœ¨ OAuth åŒæ„å±å¹•æ·»åŠ æµ‹è¯•ç”¨æˆ·ï¼ˆä½ çš„ Gmail åœ°å€ï¼‰
              </div>
            </div>
          </div>
        </div>

        <!-- Step 3 -->
        <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
          <div class="flex gap-4">
            <div class="step-number bg-purple-600 rounded-full flex items-center justify-center font-bold shrink-0">3</div>
            <div class="flex-1">
              <h3 class="font-bold text-lg mb-2">åˆ›å»º Cloudflare Worker</h3>
              <ol class="list-decimal list-inside text-gray-300 space-y-1 ml-1">
                <li>ç™»å½• <a href="https://dash.cloudflare.com" target="_blank" class="text-purple-400 hover:underline">Cloudflare Dashboard</a></li>
                <li>è¿›å…¥ Workers & Pages â†’ Create application â†’ Create Worker</li>
                <li>ç»™ Worker èµ·åï¼ˆå¦‚ <code class="bg-gray-700 px-2 py-0.5 rounded">gmail-bot</code>ï¼‰</li>
                <li>ç‚¹å‡» Deploy åˆ›å»º</li>
              </ol>
            </div>
          </div>
        </div>

        <!-- Step 4 -->
        <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
          <div class="flex gap-4">
            <div class="step-number bg-purple-600 rounded-full flex items-center justify-center font-bold shrink-0">4</div>
            <div class="flex-1">
              <h3 class="font-bold text-lg mb-2">åˆ›å»º KV Namespace</h3>
              <ol class="list-decimal list-inside text-gray-300 space-y-1 ml-1">
                <li>Workers & Pages â†’ KV â†’ Create namespace</li>
                <li>åç§°å¡« <code class="bg-gray-700 px-2 py-0.5 rounded">USER_TOKENS</code></li>
                <li>è¿›å…¥ Worker Settings â†’ Variables â†’ KV Namespace Bindings</li>
                <li>Add bindingï¼šVariable name å¡« <code class="bg-gray-700 px-2 py-0.5 rounded">USER_TOKENS</code></li>
              </ol>
            </div>
          </div>
        </div>

        <!-- Step 5 -->
        <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
          <div class="flex gap-4">
            <div class="step-number bg-purple-600 rounded-full flex items-center justify-center font-bold shrink-0">5</div>
            <div class="flex-1">
              <h3 class="font-bold text-lg mb-2">è®¾ç½®ç¯å¢ƒå˜é‡</h3>
              <p class="text-gray-300 mb-3">åœ¨ Worker Settings â†’ Variables â†’ Environment Variables æ·»åŠ ï¼š</p>
              <div class="bg-gray-900 rounded-lg p-4 space-y-2 font-mono text-sm">
                <div><span class="text-purple-400">BOT_TOKEN</span> = <span class="text-gray-400">ä½ çš„ Telegram Bot Token</span></div>
                <div><span class="text-purple-400">BOT_SECRET</span> = <span class="text-gray-400">è‡ªå®šä¹‰å¯†ç ï¼ˆå¦‚ mysecret123ï¼‰</span></div>
                <div><span class="text-purple-400">GOOGLE_CLIENT_ID</span> = <span class="text-gray-400">OAuth Client ID</span></div>
                <div><span class="text-purple-400">GOOGLE_CLIENT_SECRET</span> = <span class="text-gray-400">OAuth Client Secret</span></div>
                <div><span class="text-green-400">PUBSUB_TOPIC</span> = <span class="text-gray-400">ï¼ˆå¯é€‰ï¼‰projects/é¡¹ç›®ID/topics/ä¸»é¢˜å</span></div>
              </div>
              <div class="mt-3 p-3 bg-blue-900/30 border border-blue-700/50 rounded-lg text-blue-200 text-sm">
                ğŸ’¡ å»ºè®®å°† GOOGLE_CLIENT_SECRET è®¾ä¸ºåŠ å¯†å˜é‡ï¼ˆEncryptï¼‰
              </div>
            </div>
          </div>
        </div>

        <!-- Step 6 -->
        <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
          <div class="flex gap-4">
            <div class="step-number bg-purple-600 rounded-full flex items-center justify-center font-bold shrink-0">6</div>
            <div class="flex-1">
              <h3 class="font-bold text-lg mb-2">å¤åˆ¶ä»£ç åˆ° Worker</h3>
              <ol class="list-decimal list-inside text-gray-300 space-y-1 ml-1">
                <li>åœ¨ Worker é¡µé¢ç‚¹å‡» "Edit code" æˆ– "Quick edit"</li>
                <li>åˆ é™¤é»˜è®¤ä»£ç </li>
                <li>å¤åˆ¶ä¸‹æ–¹å®Œæ•´ä»£ç ç²˜è´´</li>
                <li>ç‚¹å‡» Save and Deploy</li>
              </ol>
            </div>
          </div>
        </div>

        <!-- Step 7 -->
        <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
          <div class="flex gap-4">
            <div class="step-number bg-purple-600 rounded-full flex items-center justify-center font-bold shrink-0">7</div>
            <div class="flex-1">
              <h3 class="font-bold text-lg mb-2">ä¸€é”®è®¾ç½® Webhook</h3>
              <p class="text-gray-300 mb-2">æµè§ˆå™¨è®¿é—®ä»¥ä¸‹åœ°å€å®Œæˆè®¾ç½®ï¼š</p>
              <code class="block bg-gray-700 px-3 py-2 rounded text-sm break-all">
                https://your-worker.workers.dev/setup?secret=ä½ çš„BOT_SECRET
              </code>
              <p class="text-gray-400 text-sm mt-2">çœ‹åˆ° "âœ… è®¾ç½®æˆåŠŸ" å³å®Œæˆ</p>
            </div>
          </div>
        </div>

        <!-- Step 8 (Optional) -->
        <div class="bg-gray-800 rounded-xl p-6 border border-orange-700/50">
          <div class="flex gap-4">
            <div class="step-number bg-orange-600 rounded-full flex items-center justify-center font-bold shrink-0 text-sm">é€‰</div>
            <div class="flex-1">
              <h3 class="font-bold text-lg mb-2 text-orange-400">é…ç½®å®æ—¶æ¨é€ï¼ˆå¯é€‰ï¼‰</h3>
              <ol class="list-decimal list-inside text-gray-300 space-y-2 ml-1">
                <li>è¿›å…¥ <a href="https://console.cloud.google.com/cloudpubsub/topic" target="_blank" class="text-purple-400 hover:underline">Google Cloud Pub/Sub</a></li>
                <li>åˆ›å»º Topicï¼ˆå¦‚ <code class="bg-gray-700 px-2 py-0.5 rounded">gmail-notifications</code>ï¼‰</li>
                <li>ç»™ Topic æ·»åŠ æƒé™ï¼š<code class="bg-gray-700 px-2 py-0.5 rounded">gmail-api-push@system.gserviceaccount.com</code> â†’ Pub/Sub Publisher</li>
                <li>åˆ›å»º Push Subscriptionï¼Œç«¯ç‚¹ï¼š<code class="bg-gray-700 px-2 py-0.5 rounded">https://your-worker.workers.dev/pubsub/push?secret=BOT_SECRET</code></li>
                <li>æ·»åŠ ç¯å¢ƒå˜é‡ <code class="bg-gray-700 px-2 py-0.5 rounded">PUBSUB_TOPIC</code></li>
                <li>è®¾ç½® Cron Triggerï¼š<code class="bg-gray-700 px-2 py-0.5 rounded">0 0 * * *</code>ï¼ˆæ¯å¤©è‡ªåŠ¨ç»­æœŸ watchï¼‰</li>
              </ol>
            </div>
          </div>
        </div>

        <!-- Done -->
        <div class="bg-gray-800 rounded-xl p-6 border border-gray-700 border-green-500/50">
          <div class="flex gap-4">
            <div class="step-number bg-green-600 rounded-full flex items-center justify-center font-bold shrink-0">âœ“</div>
            <div class="flex-1">
              <h3 class="font-bold text-lg mb-2 text-green-400">å¼€å§‹ä½¿ç”¨ï¼</h3>
              <ol class="list-decimal list-inside text-gray-300 space-y-1 ml-1">
                <li>åœ¨ Telegram æ‰¾åˆ°ä½ çš„ Bot</li>
                <li>å‘é€ä»»æ„æ¶ˆæ¯æˆ–ç‚¹å‡» <code class="bg-gray-700 px-2 py-0.5 rounded">å¼€å§‹</code></li>
                <li>ä½¿ç”¨åº•éƒ¨æŒ‰é’®èœå•æ“ä½œ</li>
                <li>ç‚¹å‡» <code class="bg-gray-700 px-2 py-0.5 rounded">ğŸ‘¤ è´¦æˆ·ç®¡ç†</code> â†’ <code class="bg-gray-700 px-2 py-0.5 rounded">â• æ·»åŠ è´¦æˆ·</code> ç»‘å®š Gmail</li>
              </ol>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Complete Code -->
    <section class="mb-16">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-bold flex items-center gap-2">
          <span class="text-purple-400">ğŸ“„</span> å®Œæ•´ Worker ä»£ç 
        </h2>
        <button id="copyBtn" class="copy-btn bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-lg font-semibold transition flex items-center gap-2">
          <span id="copyIcon">ğŸ“‹</span>
          <span id="copyText">å¤åˆ¶ä»£ç </span>
        </button>
      </div>
      
      <div class="bg-gray-800 rounded-xl border border-gray-700 overflow-hidden">
        <div class="bg-gray-700/50 px-4 py-2 flex items-center gap-2 border-b border-gray-700">
          <span class="w-3 h-3 rounded-full bg-red-500"></span>
          <span class="w-3 h-3 rounded-full bg-yellow-500"></span>
          <span class="w-3 h-3 rounded-full bg-green-500"></span>
          <span class="ml-2 text-gray-400 text-sm font-mono">worker.js</span>
        </div>
        <div class="code-container">
          <pre><code class="language-javascript" id="workerCode"></code></pre>
        </div>
      </div>
    </section>

    <!-- Environment Variables -->
    <section class="mb-16">
      <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
        <span class="text-purple-400">âš™ï¸</span> ç¯å¢ƒå˜é‡è¯´æ˜
      </h2>
      <div class="bg-gray-800 rounded-xl border border-gray-700 overflow-hidden">
        <table class="w-full">
          <thead class="bg-gray-700/50">
            <tr>
              <th class="text-left px-5 py-3 font-semibold">å˜é‡å</th>
              <th class="text-left px-5 py-3 font-semibold">å¿…éœ€</th>
              <th class="text-left px-5 py-3 font-semibold">è¯´æ˜</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-700">
            <tr>
              <td class="px-5 py-3 font-mono text-purple-400">BOT_TOKEN</td>
              <td class="px-5 py-3">âœ…</td>
              <td class="px-5 py-3 text-gray-300">Telegram Bot Token</td>
            </tr>
            <tr>
              <td class="px-5 py-3 font-mono text-purple-400">BOT_SECRET</td>
              <td class="px-5 py-3">âœ…</td>
              <td class="px-5 py-3 text-gray-300">Webhook ä¿æŠ¤å¯†ç </td>
            </tr>
            <tr>
              <td class="px-5 py-3 font-mono text-purple-400">GOOGLE_CLIENT_ID</td>
              <td class="px-5 py-3">âœ…</td>
              <td class="px-5 py-3 text-gray-300">Google OAuth Client ID</td>
            </tr>
            <tr>
              <td class="px-5 py-3 font-mono text-purple-400">GOOGLE_CLIENT_SECRET</td>
              <td class="px-5 py-3">âœ…</td>
              <td class="px-5 py-3 text-gray-300">Google OAuth Secret (å»ºè®®åŠ å¯†)</td>
            </tr>
            <tr>
              <td class="px-5 py-3 font-mono text-green-400">PUBSUB_TOPIC</td>
              <td class="px-5 py-3">â­•</td>
              <td class="px-5 py-3 text-gray-300">Pub/Sub ä¸»é¢˜ï¼ˆå®æ—¶æ¨é€éœ€è¦ï¼‰</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- Troubleshooting -->
    <section class="mb-16">
      <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
        <span class="text-purple-400">ğŸ”§</span> å¸¸è§é—®é¢˜
      </h2>
      <div class="space-y-4">
        <details class="bg-gray-800 rounded-xl border border-gray-700">
          <summary class="px-5 py-4 cursor-pointer font-semibold">æˆæƒæ—¶æç¤º "Access blocked" æˆ– "æœªç»éªŒè¯çš„åº”ç”¨"</summary>
          <div class="px-5 pb-4 text-gray-300">
            <p>è¿™æ˜¯å› ä¸º Google åº”ç”¨æœªå‘å¸ƒã€‚è§£å†³æ–¹æ³•ï¼š</p>
            <ol class="list-decimal list-inside mt-2 space-y-1">
              <li>è¿›å…¥ Google Cloud Console â†’ OAuth åŒæ„å±å¹•</li>
              <li>åœ¨"æµ‹è¯•ç”¨æˆ·"ä¸­æ·»åŠ ä½ çš„ Gmail åœ°å€</li>
              <li>æˆ–è€…å‘å¸ƒåº”ç”¨ï¼ˆéœ€è¦éªŒè¯ï¼‰</li>
            </ol>
          </div>
        </details>
        
        <details class="bg-gray-800 rounded-xl border border-gray-700">
          <summary class="px-5 py-4 cursor-pointer font-semibold">æç¤º "redirect_uri_mismatch"</summary>
          <div class="px-5 pb-4 text-gray-300">
            <p>é‡å®šå‘ URI ä¸åŒ¹é…ã€‚ç¡®ä¿ Google Console ä¸­çš„æˆæƒé‡å®šå‘ URI å®Œå…¨åŒ¹é…ï¼š</p>
            <code class="block bg-gray-700 px-3 py-2 rounded mt-2 text-sm">https://your-worker.workers.dev/oauth/callback</code>
          </div>
        </details>
        
        <details class="bg-gray-800 rounded-xl border border-gray-700">
          <summary class="px-5 py-4 cursor-pointer font-semibold">Bot æ²¡æœ‰å“åº”</summary>
          <div class="px-5 pb-4 text-gray-300">
            <ol class="list-decimal list-inside space-y-1">
              <li>ç¡®è®¤å·²è®¿é—® <code class="bg-gray-700 px-2 py-0.5 rounded">/setup?secret=xxx</code> è®¾ç½® Webhook</li>
              <li>æ£€æŸ¥ Worker æ—¥å¿—æ˜¯å¦æœ‰é”™è¯¯</li>
              <li>ç¡®è®¤ç¯å¢ƒå˜é‡é…ç½®æ­£ç¡®</li>
              <li>ç¡®è®¤ KV Namespace å·²ç»‘å®š</li>
            </ol>
          </div>
        </details>
        
        <details class="bg-gray-800 rounded-xl border border-gray-700">
          <summary class="px-5 py-4 cursor-pointer font-semibold">åº•éƒ¨æŒ‰é’®ä¸æ˜¾ç¤º</summary>
          <div class="px-5 pb-4 text-gray-300">
            <p>ReplyKeyboard æŒ‰é’®éœ€è¦ Bot å‘é€ä¸€æ¬¡æ¶ˆæ¯åæ‰ä¼šæ˜¾ç¤ºã€‚å°è¯•ï¼š</p>
            <ol class="list-decimal list-inside mt-2 space-y-1">
              <li>å‘ Bot å‘é€ä»»æ„æ¶ˆæ¯</li>
              <li>æˆ–å‘é€ /start å‘½ä»¤</li>
              <li>æŒ‰é’®ä¼šå‡ºç°åœ¨è¾“å…¥æ¡†ä¸Šæ–¹</li>
            </ol>
          </div>
        </details>

        <details class="bg-gray-800 rounded-xl border border-gray-700">
          <summary class="px-5 py-4 cursor-pointer font-semibold">æ¨é€åŠŸèƒ½ä¸å·¥ä½œ</summary>
          <div class="px-5 pb-4 text-gray-300">
            <ol class="list-decimal list-inside space-y-1">
              <li>ç¡®è®¤å·²åˆ›å»º Pub/Sub Topic å¹¶é…ç½® PUBSUB_TOPIC å˜é‡</li>
              <li>ç¡®è®¤ Push Subscription ç«¯ç‚¹æ­£ç¡®</li>
              <li>ç¡®è®¤ gmail-api-push@system.gserviceaccount.com æœ‰å‘å¸ƒæƒé™</li>
              <li>åœ¨ Bot ä¸­ç‚¹å‡» âš™ï¸ è®¾ç½® â†’ ğŸ”” å¼€å¯æ¨é€</li>
              <li>è®¾ç½® Cron Trigger æ¯å¤©ç»­æœŸ watch</li>
            </ol>
          </div>
        </details>
      </div>
    </section>

    <!-- Architecture -->
    <section class="mb-16">
      <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
        <span class="text-purple-400">ğŸ—ï¸</span> æ¶æ„è¯´æ˜
      </h2>
      <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
        <div class="flex flex-wrap gap-4 justify-center items-center text-center">
          <div class="bg-blue-600/20 border border-blue-500/50 rounded-lg px-4 py-3">
            <div class="text-2xl mb-1">ğŸ“±</div>
            <div class="text-sm">Telegram</div>
          </div>
          <div class="text-gray-500">â†’</div>
          <div class="bg-orange-600/20 border border-orange-500/50 rounded-lg px-4 py-3">
            <div class="text-2xl mb-1">âš¡</div>
            <div class="text-sm">Cloudflare Worker</div>
          </div>
          <div class="text-gray-500">â†’</div>
          <div class="bg-red-600/20 border border-red-500/50 rounded-lg px-4 py-3">
            <div class="text-2xl mb-1">ğŸ“§</div>
            <div class="text-sm">Gmail API</div>
          </div>
        </div>
        <div class="mt-4 flex flex-wrap gap-4 justify-center items-center text-center">
          <div class="bg-green-600/20 border border-green-500/50 rounded-lg px-4 py-3">
            <div class="text-2xl mb-1">ğŸ“¡</div>
            <div class="text-sm">Pub/Sub</div>
          </div>
          <div class="text-gray-500">â†’</div>
          <div class="bg-orange-600/20 border border-orange-500/50 rounded-lg px-4 py-3">
            <div class="text-2xl mb-1">âš¡</div>
            <div class="text-sm">Worker</div>
          </div>
          <div class="text-gray-500">â†’</div>
          <div class="bg-blue-600/20 border border-blue-500/50 rounded-lg px-4 py-3">
            <div class="text-2xl mb-1">ğŸ””</div>
            <div class="text-sm">æ¨é€é€šçŸ¥</div>
          </div>
        </div>
        <div class="mt-6 grid md:grid-cols-3 gap-4 text-center text-sm">
          <div class="bg-gray-700/30 rounded-lg p-3">
            <div class="text-purple-400 font-semibold mb-1">KV Storage</div>
            <div class="text-gray-400">å­˜å‚¨ç”¨æˆ· Token å’Œè´¦æˆ·ä¿¡æ¯</div>
          </div>
          <div class="bg-gray-700/30 rounded-lg p-3">
            <div class="text-purple-400 font-semibold mb-1">å¤šè´¦æˆ·</div>
            <div class="text-gray-400">æ¯ç”¨æˆ·æ”¯æŒå¤šä¸ª Gmail</div>
          </div>
          <div class="bg-gray-700/30 rounded-lg p-3">
            <div class="text-purple-400 font-semibold mb-1">Cron Trigger</div>
            <div class="text-gray-400">è‡ªåŠ¨ç»­æœŸ Watch</div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Footer -->
  <footer class="bg-gray-800/50 border-t border-gray-700 py-8 px-4">
    <div class="max-w-5xl mx-auto text-center text-gray-400">
      <p>Gmail Telegram Bot - åŸºäº Cloudflare Workers</p>
      <p class="mt-2 text-sm">å®Œå…¨å…è´¹ Â· å¤šè´¦æˆ·æ”¯æŒ Â· å®æ—¶æ¨é€ Â· å®‰å…¨å¯é </p>
    </div>
  </footer>

  <script>
    // Worker ä»£ç 
    const workerCode = `/**
 * Gmail Telegram Bot - Cloudflare Worker
 * åŠŸèƒ½ï¼šé€šè¿‡ Telegram Bot å®‰å…¨è®¿é—® Gmail é‚®ç®±
 * ç‰¹æ€§ï¼šå¤šè´¦æˆ·ã€åˆ†é¡µæµè§ˆã€å®æ—¶æ¨é€ã€æ‰¹é‡æ“ä½œ
 */

const GMAIL_SCOPES = [
  'https://www.googleapis.com/auth/gmail.readonly',
  'https://www.googleapis.com/auth/gmail.modify'
].join(' ');

const PAGE_SIZE = 5;
const MAX_CONTENT_LENGTH = 3500;
const PREVIEW_LENGTH = 300;
const TOKEN_REFRESH_BUFFER = 60000;
const WATCH_EXPIRY_BUFFER = 86400000;
const MAX_ATTACHMENT_SIZE = 20 * 1024 * 1024;

// ==================== ä¸»å…¥å£ ====================
export default {
  async fetch(request, env, ctx) {
    const url = new URL(request.url);
    const path = url.pathname;

    try {
      // è®¾ç½®æ¥å£
      if (path === '/setup') {
        return await handleSetup(url, env);
      }
      
      // OAuth å›è°ƒ
      if (path === '/oauth/callback') {
        return await handleOAuthCallback(request, env);
      }
      
      // Pub/Sub æ¨é€
      if (path === '/pubsub/push') {
        const secret = url.searchParams.get('secret');
        if (secret !== env.BOT_SECRET) {
          return jsonResponse({ error: 'Unauthorized' }, 401);
        }
        const message = await request.json();
        ctx.waitUntil(handlePubSubPush(message, env));
        return jsonResponse({ ok: true });
      }
      
      // Telegram Webhook
      if (path === '/webhook' && request.method === 'POST') {
        const secret = url.searchParams.get('secret');
        if (secret !== env.BOT_SECRET) {
          return jsonResponse({ error: 'Unauthorized' }, 401);
        }
        const update = await request.json();
        ctx.waitUntil(handleBotUpdate(update, env, url.origin));
        return jsonResponse({ ok: true });
      }

      // é¦–é¡µ
      return new Response(generateHomePage(), {
        headers: { 'Content-Type': 'text/html; charset=utf-8' }
      });
    } catch (error) {
      console.error('Error:', error);
      return jsonResponse({ error: error.message }, 500);
    }
  },

  // Cron è§¦å‘å™¨ - ç»­æœŸ watch
  async scheduled(event, env, ctx) {
    ctx.waitUntil(renewAllWatches(env));
  }
};

// ==================== Webhook è®¾ç½® ====================
async function handleSetup(url, env) {
  const secret = url.searchParams.get('secret');
  if (secret !== env.BOT_SECRET) {
    return new Response('âŒ é”™è¯¯ï¼šè¯·æä¾›æ­£ç¡®çš„ secret å‚æ•°', { 
      status: 401,
      headers: { 'Content-Type': 'text/plain; charset=utf-8' }
    });
  }

  const webhookUrl = \`\${url.origin}/webhook?secret=\${env.BOT_SECRET}\`;
  const results = [];

  // è®¾ç½® Webhook
  const webhookResp = await telegramAPI(env.BOT_TOKEN, 'setWebhook', { 
    url: webhookUrl,
    allowed_updates: ['message', 'callback_query']
  });
  results.push(\`Webhook: \${webhookResp.ok ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥'}\`);

  // æ¸…é™¤å‘½ä»¤èœå•ï¼ˆä½¿ç”¨æŒ‰é’®èœå•ï¼‰
  await telegramAPI(env.BOT_TOKEN, 'deleteMyCommands', {});
  results.push('å‘½ä»¤èœå•: âœ… å·²æ¸…é™¤ï¼ˆä½¿ç”¨æŒ‰é’®èœå•ï¼‰');

  // è·å– Bot ä¿¡æ¯
  const meResp = await telegramAPI(env.BOT_TOKEN, 'getMe');
  if (meResp.ok) {
    results.push(\`Bot: @\${meResp.result.username}\`);
  }

  return new Response(\`ğŸ¤– Gmail Bot è®¾ç½®ç»“æœ\\n\${'â•'.repeat(30)}\\n\\n\${results.join('\\n')}\\n\\nâœ… ç°åœ¨å¯ä»¥åœ¨ Telegram ä¸­ä½¿ç”¨ Bot äº†ï¼\\n\\nğŸ’¡ æç¤ºï¼šå‘é€ä»»æ„æ¶ˆæ¯ç»™ Bot å³å¯å¼€å§‹\`, {
    headers: { 'Content-Type': 'text/plain; charset=utf-8' }
  });
}

// ==================== OAuth å›è°ƒå¤„ç† ====================
async function handleOAuthCallback(request, env) {
  const url = new URL(request.url);
  const code = url.searchParams.get('code');
  const state = url.searchParams.get('state');
  const error = url.searchParams.get('error');

  if (error) {
    return new Response(generateResultPage(false, \`æˆæƒè¢«æ‹’ç»: \${error}\`), {
      headers: { 'Content-Type': 'text/html; charset=utf-8' }
    });
  }

  if (!code || !state) {
    return new Response(generateResultPage(false, 'ç¼ºå°‘å¿…è¦å‚æ•°'), {
      headers: { 'Content-Type': 'text/html; charset=utf-8' }
    });
  }

  let stateData;
  try {
    stateData = JSON.parse(atob(state));
  } catch {
    return new Response(generateResultPage(false, 'State å‚æ•°æ— æ•ˆ'), {
      headers: { 'Content-Type': 'text/html; charset=utf-8' }
    });
  }

  const { userId, nonce } = stateData;
  
  // éªŒè¯ nonce
  const storedNonce = await env.USER_TOKENS.get(\`nonce:\${userId}\`);
  if (!storedNonce || storedNonce !== nonce) {
    return new Response(generateResultPage(false, 'æˆæƒå·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•'), {
      headers: { 'Content-Type': 'text/html; charset=utf-8' }
    });
  }

  // äº¤æ¢ Token
  const tokenResp = await fetch('https://oauth2.googleapis.com/token', {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: new URLSearchParams({
      code,
      client_id: env.GOOGLE_CLIENT_ID,
      client_secret: env.GOOGLE_CLIENT_SECRET,
      redirect_uri: \`\${url.origin}/oauth/callback\`,
      grant_type: 'authorization_code'
    })
  });

  const tokenData = await tokenResp.json();

  if (!tokenData.access_token) {
    return new Response(generateResultPage(false, tokenData.error_description || 'Token è·å–å¤±è´¥'), {
      headers: { 'Content-Type': 'text/html; charset=utf-8' }
    });
  }

  // è·å–é‚®ç®±ä¿¡æ¯
  const profileResp = await fetch('https://gmail.googleapis.com/gmail/v1/users/me/profile', {
    headers: { Authorization: \`Bearer \${tokenData.access_token}\` }
  });
  const profile = await profileResp.json();
  const email = profile.emailAddress || 'unknown';

  // ä¿å­˜è´¦æˆ· Token
  await env.USER_TOKENS.put(\`token:\${userId}:\${email}\`, JSON.stringify({
    access_token: tokenData.access_token,
    refresh_token: tokenData.refresh_token,
    expiry: Date.now() + (tokenData.expires_in * 1000),
    email: email
  }));

  // æ›´æ–°è´¦æˆ·åˆ—è¡¨
  let accounts = [];
  try {
    const accountsRaw = await env.USER_TOKENS.get(\`accounts:\${userId}\`);
    if (accountsRaw) accounts = JSON.parse(accountsRaw);
  } catch {}
  
  if (!accounts.includes(email)) {
    accounts.push(email);
    await env.USER_TOKENS.put(\`accounts:\${userId}\`, JSON.stringify(accounts));
  }

  // è®¾ç½®ä¸ºå½“å‰æ´»è·ƒè´¦æˆ·
  await env.USER_TOKENS.put(\`active:\${userId}\`, email);

  // æ¸…é™¤ nonce
  await env.USER_TOKENS.delete(\`nonce:\${userId}\`);

  // å‘é€æˆåŠŸæ¶ˆæ¯åˆ° Telegram
  await telegramAPI(env.BOT_TOKEN, 'sendMessage', {
    chat_id: userId,
    text: \`âœ… *è´¦æˆ·ç»‘å®šæˆåŠŸï¼*\\n\\nğŸ“§ \${email}\\n\\nå·²è®¾ä¸ºå½“å‰ä½¿ç”¨è´¦æˆ·ï¼Œç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹ä½¿ç”¨\`,
    parse_mode: 'Markdown',
    reply_markup: getMainKeyboard()
  });

  return new Response(generateResultPage(true, email), {
    headers: { 'Content-Type': 'text/html; charset=utf-8' }
  });
}

// ç”Ÿæˆç»“æœé¡µé¢
function generateResultPage(success, message) {
  const bgColor = success ? '#10b981' : '#ef4444';
  const icon = success ? 'âœ“' : 'âœ•';
  const title = success ? 'æˆæƒæˆåŠŸï¼' : 'æˆæƒå¤±è´¥';
  
  return \`<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>\${title} - Gmail Bot</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      color: #fff;
      padding: 20px;
    }
    .card {
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(20px);
      border-radius: 24px;
      padding: 48px;
      text-align: center;
      max-width: 420px;
      width: 100%;
      border: 1px solid rgba(255,255,255,0.2);
      box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
    }
    .icon {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 24px;
      font-size: 40px;
      font-weight: bold;
      background: \${bgColor};
      box-shadow: 0 10px 40px \${bgColor}66;
      animation: \${success ? 'bounce' : 'shake'} 0.5s ease;
    }
    @keyframes bounce {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }
    h1 { font-size: 28px; margin-bottom: 16px; }
    .email {
      background: rgba(99,102,241,0.2);
      border: 1px solid rgba(99,102,241,0.3);
      padding: 16px 24px;
      border-radius: 12px;
      margin: 24px 0;
      font-size: 16px;
      word-break: break-all;
    }
    .hint { color: #94a3b8; font-size: 14px; margin-bottom: 24px; }
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 14px 32px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      text-decoration: none;
      border-radius: 12px;
      font-weight: 600;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102,126,234,0.4);
    }
    .features {
      display: flex;
      justify-content: center;
      gap: 16px;
      margin-top: 32px;
      flex-wrap: wrap;
    }
    .feature {
      background: rgba(255,255,255,0.05);
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 12px;
      color: #a5b4fc;
    }
  </style>
</head>
<body>
  <div class="card">
    <div class="icon">\${icon}</div>
    <h1>\${title}</h1>
    <div class="email">\${success ? 'ğŸ“§ ' + message : 'âŒ ' + message}</div>
    <p class="hint">\${success ? 'è´¦æˆ·å·²æ·»åŠ ï¼Œå¯ä»¥å…³é—­æ­¤é¡µé¢è¿”å› Telegram' : 'è¯·è¿”å› Telegram é‡è¯•'}</p>
    <a href="https://t.me" class="btn">ğŸ“± è¿”å› Telegram</a>
    \${success ? '<div class="features"><span class="feature">ğŸ”’ å®‰å…¨åŠ å¯†</span><span class="feature">ğŸ“¨ å®æ—¶æ¨é€</span><span class="feature">ğŸ‘¥ å¤šè´¦æˆ·</span></div>' : ''}
  </div>
</body>
</html>\`;
}

// ==================== Pub/Sub æ¨é€å¤„ç† ====================
async function handlePubSubPush(message, env) {
  if (!message.message?.data) return;

  const data = JSON.parse(atob(message.message.data));
  const { emailAddress, historyId } = data;

  // æŸ¥æ‰¾è®¢é˜…äº†è¿™ä¸ªé‚®ç®±çš„ç”¨æˆ·
  const list = await env.USER_TOKENS.list({ prefix: 'push:' });
  
  for (const key of list.keys) {
    const pushData = await env.USER_TOKENS.get(key.name, { type: 'json' });
    if (!pushData?.enabled) continue;

    const parts = key.name.split(':');
    const userId = parts[1];
    const email = parts.slice(2).join(':');
    
    if (email !== emailAddress) continue;

    // è·å– token
    const tokenData = await getValidToken(userId, email, env);
    if (!tokenData) continue;

    // è·å–æ–°é‚®ä»¶
    try {
      const historyUrl = new URL('https://gmail.googleapis.com/gmail/v1/users/me/history');
      historyUrl.searchParams.set('startHistoryId', pushData.historyId || historyId);
      historyUrl.searchParams.set('historyTypes', 'messageAdded');
      historyUrl.searchParams.set('labelId', 'INBOX');

      const historyResp = await fetch(historyUrl, {
        headers: { Authorization: \`Bearer \${tokenData.access_token}\` }
      });
      const historyData = await historyResp.json();

      if (historyData.history) {
        for (const h of historyData.history) {
          if (h.messagesAdded) {
            for (const m of h.messagesAdded) {
              await sendNewMailNotification(userId, email, m.message.id, tokenData.access_token, env);
            }
          }
        }
      }

      // æ›´æ–° historyId
      pushData.historyId = historyData.historyId || historyId;
      await env.USER_TOKENS.put(key.name, JSON.stringify(pushData));
    } catch (e) {
      console.error('Push notification error:', e);
    }
  }
}

// å‘é€æ–°é‚®ä»¶é€šçŸ¥
async function sendNewMailNotification(userId, email, messageId, accessToken, env) {
  const detailResp = await fetch(
    \`https://gmail.googleapis.com/gmail/v1/users/me/messages/\${messageId}?format=metadata&metadataHeaders=From&metadataHeaders=Subject\`,
    { headers: { Authorization: \`Bearer \${accessToken}\` } }
  );
  
  if (!detailResp.ok) return;

  const mail = await detailResp.json();
  const headers = mail.payload?.headers || [];
  const getHeader = (name) => headers.find(h => h.name.toLowerCase() === name.toLowerCase())?.value || '';

  const from = getHeader('From');
  const subject = getHeader('Subject') || '(æ— ä¸»é¢˜)';

  let fromName = from;
  const emailMatch = from.match(/[\\w.-]+@[\\w.-]+\\.\\w+/);
  if (emailMatch) {
    fromName = from.replace(emailMatch[0], '').replace(/[<>"]/g, '').trim() || emailMatch[0];
  }

  const text = \`ğŸ”” *æ–°é‚®ä»¶é€šçŸ¥*\\n\${'â”'.repeat(18)}\\n\\nğŸ“§ \${email}\\n\\nğŸ‘¤ \${fromName}\\nğŸ“‹ \${subject}\`;

  const keyboard = {
    inline_keyboard: [
      [{ text: 'ğŸ“– æŸ¥çœ‹è¯¦æƒ…', callback_data: \`mail:\${messageId}\` }],
      [
        { text: 'âœ… æ ‡è®°å·²è¯»', callback_data: \`read:\${messageId}\` },
        { text: 'ğŸ—‘ï¸ åˆ é™¤', callback_data: \`delete:\${messageId}\` }
      ]
    ]
  };

  await telegramAPI(env.BOT_TOKEN, 'sendMessage', {
    chat_id: userId,
    text,
    parse_mode: 'Markdown',
    reply_markup: keyboard
  });
}

// ç»­æœŸæ‰€æœ‰ watch
async function renewAllWatches(env) {
  if (!env.PUBSUB_TOPIC) return;

  const list = await env.USER_TOKENS.list({ prefix: 'push:' });
  
  for (const key of list.keys) {
    const pushData = await env.USER_TOKENS.get(key.name, { type: 'json' });
    if (!pushData?.enabled) continue;

    const parts = key.name.split(':');
    const userId = parts[1];
    const email = parts.slice(2).join(':');

    const tokenData = await getValidToken(userId, email, env);
    if (!tokenData) continue;

    try {
      const watchResp = await fetch('https://gmail.googleapis.com/gmail/v1/users/me/watch', {
        method: 'POST',
        headers: {
          Authorization: \`Bearer \${tokenData.access_token}\`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          topicName: env.PUBSUB_TOPIC,
          labelIds: ['INBOX']
        })
      });

      const watchData = await watchResp.json();
      if (watchData.historyId) {
        pushData.historyId = watchData.historyId;
        pushData.watchExpiry = parseInt(watchData.expiration);
        await env.USER_TOKENS.put(key.name, JSON.stringify(pushData));
      }
    } catch (e) {
      console.error('Watch renewal error:', e);
    }
  }
}

// ==================== Bot æ›´æ–°å¤„ç† ====================
async function handleBotUpdate(update, env, origin) {
  if (update.callback_query) {
    await handleCallbackQuery(update.callback_query, env, origin);
    return;
  }

  if (!update.message) return;

  const msg = update.message;
  const chatId = msg.chat.id;
  const userId = msg.from.id.toString();
  const text = (msg.text || '').trim();

  // ä¿å­˜ origin ä¾›ç™»å½•ä½¿ç”¨
  await env.USER_TOKENS.put('worker_origin', origin);

  // æŒ‰é’®æ–‡æœ¬å¤„ç†
  const handlers = {
    '/start': () => sendWelcome(chatId, userId, env),
    'ğŸ  ä¸»èœå•': () => sendWelcome(chatId, userId, env),
    'ğŸ“¬ æ”¶ä»¶ç®±': () => handleMailList(chatId, userId, 'in:inbox', null, null, env),
    'ğŸ“… ä»Šæ—¥': () => handleMailList(chatId, userId, \`after:\${getTodayDate()}\`, null, null, env),
    'â­ æ˜Ÿæ ‡': () => handleMailList(chatId, userId, 'is:starred', null, null, env),
    'ğŸ” æœç´¢': () => sendSearchHelp(chatId, env),
    'ğŸ“Š ç»Ÿè®¡': () => handleStats(chatId, userId, null, env),
    'âœ… å…¨å·²è¯»': () => handleMarkAllRead(chatId, userId, env),
    'ğŸ‘¤ è´¦æˆ·ç®¡ç†': () => handleAccountManage(chatId, userId, null, env),
    'âš™ï¸ è®¾ç½®': () => sendSettings(chatId, userId, env)
  };

  if (handlers[text]) {
    await handlers[text]();
    return;
  }

  // æœç´¢å‘½ä»¤
  if (text.startsWith('/search ') || text.startsWith('æœç´¢ ')) {
    const query = text.replace(/^(\\/search |æœç´¢ )/, '').trim();
    if (query) {
      await handleMailList(chatId, userId, query, null, null, env);
    }
    return;
  }

  // é»˜è®¤æ˜¾ç¤ºæ¬¢è¿
  await sendWelcome(chatId, userId, env);
}

// ==================== ä¸»é”®ç›˜ ====================
function getMainKeyboard() {
  return {
    keyboard: [
      [{ text: 'ğŸ“¬ æ”¶ä»¶ç®±' }, { text: 'ğŸ“… ä»Šæ—¥' }, { text: 'â­ æ˜Ÿæ ‡' }],
      [{ text: 'ğŸ” æœç´¢' }, { text: 'ğŸ“Š ç»Ÿè®¡' }, { text: 'âœ… å…¨å·²è¯»' }],
      [{ text: 'ğŸ‘¤ è´¦æˆ·ç®¡ç†' }, { text: 'âš™ï¸ è®¾ç½®' }, { text: 'ğŸ  ä¸»èœå•' }]
    ],
    resize_keyboard: true,
    persistent: true
  };
}

// ==================== å·¥å…·å‡½æ•° ====================
function getTodayDate() {
  const now = new Date();
  return \`\${now.getFullYear()}/\${now.getMonth() + 1}/\${now.getDate()}\`;
}

function jsonResponse(data, status = 200) {
  return new Response(JSON.stringify(data), {
    status,
    headers: { 'Content-Type': 'application/json' }
  });
}

async function telegramAPI(token, method, params = {}) {
  const resp = await fetch(\`https://api.telegram.org/bot\${token}/\${method}\`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(params)
  });
  return resp.json();
}

// è·å–å½“å‰æ´»è·ƒè´¦æˆ·çš„ Token
async function getActiveToken(userId, env) {
  const activeEmail = await env.USER_TOKENS.get(\`active:\${userId}\`);
  if (!activeEmail) return null;
  return await getValidToken(userId, activeEmail, env);
}

// è·å–å¹¶åˆ·æ–° Token
async function getValidToken(userId, email, env) {
  const raw = await env.USER_TOKENS.get(\`token:\${userId}:\${email}\`);
  if (!raw) return null;

  let tokenData;
  try {
    tokenData = JSON.parse(raw);
  } catch {
    return null;
  }

  // æ£€æŸ¥æ˜¯å¦éœ€è¦åˆ·æ–°
  if (Date.now() > tokenData.expiry - TOKEN_REFRESH_BUFFER) {
    if (!tokenData.refresh_token) return null;

    try {
      const resp = await fetch('https://oauth2.googleapis.com/token', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({
          client_id: env.GOOGLE_CLIENT_ID,
          client_secret: env.GOOGLE_CLIENT_SECRET,
          refresh_token: tokenData.refresh_token,
          grant_type: 'refresh_token'
        })
      });

      const newToken = await resp.json();
      if (!newToken.access_token) return null;

      tokenData.access_token = newToken.access_token;
      tokenData.expiry = Date.now() + (newToken.expires_in * 1000);
      await env.USER_TOKENS.put(\`token:\${userId}:\${email}\`, JSON.stringify(tokenData));
    } catch {
      return null;
    }
  }

  return tokenData;
}

// è·å–è´¦æˆ·åˆ—è¡¨
async function getAccountList(userId, env) {
  try {
    const raw = await env.USER_TOKENS.get(\`accounts:\${userId}\`);
    return raw ? JSON.parse(raw) : [];
  } catch {
    return [];
  }
}

// ==================== å‘é€æ¬¢è¿æ¶ˆæ¯ ====================
async function sendWelcome(chatId, userId, env) {
  const accounts = await getAccountList(userId, env);
  const activeEmail = await env.USER_TOKENS.get(\`active:\${userId}\`);

  let accountInfo = '';
  if (accounts.length > 0) {
    accountInfo = \`\\n\\nğŸ‘¤ *å½“å‰è´¦æˆ·:* \${activeEmail || 'æœªé€‰æ‹©'}\\nğŸ“Š å·²ç»‘å®š \${accounts.length} ä¸ªè´¦æˆ·\`;
  } else {
    accountInfo = '\\n\\nâš ï¸ å°šæœªç»‘å®šè´¦æˆ·ï¼Œè¯·ç‚¹å‡» *ğŸ‘¤ è´¦æˆ·ç®¡ç†* æ·»åŠ  Gmail';
  }

  const text = \`ğŸ¤– *Gmail Telegram Bot*\\n\${'â”'.repeat(20)}\${accountInfo}\\n\\n*å¿«æ·åŠŸèƒ½ï¼š*\\nğŸ“¬ æ”¶ä»¶ç®± - æŸ¥çœ‹æœ€æ–°é‚®ä»¶\\nğŸ“… ä»Šæ—¥ - ä»Šå¤©æ”¶åˆ°çš„é‚®ä»¶\\nâ­ æ˜Ÿæ ‡ - æ˜Ÿæ ‡é‚®ä»¶\\nğŸ” æœç´¢ - æœç´¢é‚®ä»¶\\nğŸ“Š ç»Ÿè®¡ - é‚®ç®±ç»Ÿè®¡ä¿¡æ¯\\nâœ… å…¨å·²è¯» - ä¸€é”®æ ‡è®°å…¨éƒ¨å·²è¯»\\n\\nä½¿ç”¨ä¸‹æ–¹æŒ‰é’®æ“ä½œ ğŸ‘‡\`;

  await telegramAPI(env.BOT_TOKEN, 'sendMessage', {
    chat_id: chatId,
    text,
    parse_mode: 'Markdown',
    reply_markup: getMainKeyboard()
  });
}

// ==================== è´¦æˆ·ç®¡ç† ====================
async function handleAccountManage(chatId, userId, editMsgId, env) {
  const accounts = await getAccountList(userId, env);
  const activeEmail = await env.USER_TOKENS.get(\`active:\${userId}\`);

  let text = 'ğŸ‘¤ *è´¦æˆ·ç®¡ç†*\\n' + 'â”'.repeat(20) + '\\n\\n';

  if (accounts.length === 0) {
    text += 'ğŸ“­ å°šæœªç»‘å®šä»»ä½• Gmail è´¦æˆ·\\n\\nç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ·»åŠ è´¦æˆ·';
  } else {
    text += \`ğŸ“Š å·²ç»‘å®š *\${accounts.length}* ä¸ªè´¦æˆ·\\n\\n\`;
    accounts.forEach((email, i) => {
      const isActive = email === activeEmail;
      text += \`\${isActive ? 'âœ…' : 'âšªï¸'} \${i + 1}. \${email}\${isActive ? ' _(å½“å‰)_' : ''}\\n\`;
    });
    text += '\\nç‚¹å‡»è´¦æˆ·åˆ‡æ¢ï¼Œæˆ–æ·»åŠ æ–°è´¦æˆ·';
  }

  const buttons = [];

  // è´¦æˆ·åˆ‡æ¢æŒ‰é’®
  for (let i = 0; i < accounts.length; i += 2) {
    const row = [];
    for (let j = i; j < Math.min(i + 2, accounts.length); j++) {
      const email = accounts[j];
      const isActive = email === activeEmail;
      const shortEmail = email.length > 18 ? email.substring(0, 16) + '..' : email;
      row.push({
        text: \`\${isActive ? 'âœ…' : 'ğŸ“§'} \${shortEmail}\`,
        callback_data: \`switch:\${email.substring(0, 50)}\`
      });
    }
    buttons.push(row);
  }

  buttons.push([
    { text: 'â• æ·»åŠ è´¦æˆ·', callback_data: 'account:add' },
    { text: 'ğŸ—‘ï¸ åˆ é™¤è´¦æˆ·', callback_data: 'account:delete_menu' }
  ]);
  buttons.push([{ text: 'ğŸ”„ åˆ·æ–°', callback_data: 'account:refresh' }]);

  const keyboard = { inline_keyboard: buttons };

  if (editMsgId) {
    await telegramAPI(env.BOT_TOKEN, 'editMessageText', {
      chat_id: chatId,
      message_id: editMsgId,
      text,
      parse_mode: 'Markdown',
      reply_markup: keyboard
    });
  } else {
    await telegramAPI(env.BOT_TOKEN, 'sendMessage', {
      chat_id: chatId,
      text,
      parse_mode: 'Markdown',
      reply_markup: keyboard
    });
  }
}

// ==================== æ·»åŠ è´¦æˆ· ====================
async function sendLoginLink(chatId, userId, origin, env) {
  const nonce = crypto.randomUUID();
  await env.USER_TOKENS.put(\`nonce:\${userId}\`, nonce, { expirationTtl: 600 });

  const state = btoa(JSON.stringify({ userId, nonce }));

  const authUrl = new URL('https://accounts.google.com/o/oauth2/v2/auth');
  authUrl.searchParams.set('client_id', env.GOOGLE_CLIENT_ID);
  authUrl.searchParams.set('redirect_uri', \`\${origin}/oauth/callback\`);
  authUrl.searchParams.set('response_type', 'code');
  authUrl.searchParams.set('scope', GMAIL_SCOPES);
  authUrl.searchParams.set('access_type', 'offline');
  authUrl.searchParams.set('prompt', 'consent');
  authUrl.searchParams.set('state', state);

  const keyboard = {
    inline_keyboard: [
      [{ text: 'ğŸ” ç‚¹å‡»æˆæƒ Gmail', url: authUrl.toString() }],
      [{ text: 'â¬…ï¸ è¿”å›', callback_data: 'account:refresh' }]
    ]
  };

  await telegramAPI(env.BOT_TOKEN, 'sendMessage', {
    chat_id: chatId,
    text: 'ğŸ” *æ·»åŠ  Gmail è´¦æˆ·*\\n\\nè¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®è¿›è¡Œ Google æˆæƒ\\n\\nğŸ”’ ä½¿ç”¨ Google å®˜æ–¹ OAuthï¼Œå®‰å…¨å¯é \\nğŸ“§ ä»…è·å–é‚®ä»¶è¯»å–å’Œä¿®æ”¹æƒé™',
    parse_mode: 'Markdown',
    reply_markup: keyboard
  });
}

// ==================== è®¾ç½®é¡µé¢ ====================
async function sendSettings(chatId, userId, env) {
  const accounts = await getAccountList(userId, env);
  const activeEmail = await env.USER_TOKENS.get(\`active:\${userId}\`);

  // æ£€æŸ¥æ¨é€çŠ¶æ€
  let pushEnabled = false;
  if (activeEmail) {
    const pushData = await env.USER_TOKENS.get(\`push:\${userId}:\${activeEmail}\`, { type: 'json' });
    pushEnabled = pushData?.enabled || false;
  }

  let text = 'âš™ï¸ *è®¾ç½®*\\n' + 'â”'.repeat(20) + '\\n\\n';
  text += \`ğŸ‘¤ å½“å‰è´¦æˆ·: \${activeEmail || 'æœªç»‘å®š'}\\n\`;
  text += \`ğŸ“Š å·²ç»‘å®šè´¦æˆ·: \${accounts.length} ä¸ª\\n\`;
  text += \`ğŸ”” å®æ—¶æ¨é€: \${pushEnabled ? 'å·²å¼€å¯' : 'å·²å…³é—­'}\\n\`;

  const buttons = [
    [{ text: 'ğŸ‘¤ è´¦æˆ·ç®¡ç†', callback_data: 'account:refresh' }]
  ];

  // æ¨é€å¼€å…³ï¼ˆä»…å½“æœ‰ PUBSUB_TOPIC æ—¶æ˜¾ç¤ºï¼‰
  if (env.PUBSUB_TOPIC && activeEmail) {
    buttons.push([{
      text: pushEnabled ? 'ğŸ”• å…³é—­æ¨é€' : 'ğŸ”” å¼€å¯æ¨é€',
      callback_data: pushEnabled ? 'push:disable' : 'push:enable'
    }]);
  }

  buttons.push([
    { text: 'âœ… å…¨éƒ¨å·²è¯»', callback_data: 'action:readall' },
    { text: 'ğŸ” æœç´¢å¸®åŠ©', callback_data: 'action:search_help' }
  ]);

  await telegramAPI(env.BOT_TOKEN, 'sendMessage', {
    chat_id: chatId,
    text,
    parse_mode: 'Markdown',
    reply_markup: { inline_keyboard: buttons }
  });
}

// ==================== æœç´¢å¸®åŠ© ====================
async function sendSearchHelp(chatId, env) {
  const keyboard = {
    inline_keyboard: [
      [
        { text: 'ğŸ“¬ æœªè¯»', callback_data: 'search:is:unread' },
        { text: 'â­ æ˜Ÿæ ‡', callback_data: 'search:is:starred' },
        { text: 'ğŸ“ é™„ä»¶', callback_data: 'search:has:attachment' }
      ],
      [
        { text: 'ğŸ“… æœ¬å‘¨', callback_data: 'search:newer_than:7d' },
        { text: 'ğŸ“† æœ¬æœˆ', callback_data: 'search:newer_than:30d' }
      ],
      [
        { text: 'ğŸ”´ é‡è¦', callback_data: 'search:is:important' },
        { text: 'ğŸ“¤ å·²å‘é€', callback_data: 'search:in:sent' }
      ]
    ]
  };

  await telegramAPI(env.BOT_TOKEN, 'sendMessage', {
    chat_id: chatId,
    text: 'ğŸ” *æœç´¢é‚®ä»¶*\\n\\nç›´æ¥å‘é€æœç´¢å†…å®¹ï¼Œä¾‹å¦‚ï¼š\\nâ€¢ \`æœç´¢ ä¼šè®®é€šçŸ¥\`\\nâ€¢ \`æœç´¢ from:test@qq.com\`\\nâ€¢ \`æœç´¢ subject:å‘¨æŠ¥\`\\nâ€¢ \`æœç´¢ has:attachment å‘ç¥¨\`\\n\\næˆ–ä½¿ç”¨å¿«æ·æœç´¢ï¼š',
    parse_mode: 'Markdown',
    reply_markup: keyboard
  });
}

// ==================== é‚®ä»¶åˆ—è¡¨ï¼ˆåˆ†é¡µï¼‰====================
async function handleMailList(chatId, userId, query, pageToken, editMsgId, env) {
  const tokenData = await getActiveToken(userId, env);
  if (!tokenData) {
    await telegramAPI(env.BOT_TOKEN, 'sendMessage', {
      chat_id: chatId,
      text: 'âš ï¸ è¯·å…ˆç»‘å®š Gmail è´¦æˆ·\\n\\nç‚¹å‡» *ğŸ‘¤ è´¦æˆ·ç®¡ç†* â†’ *â• æ·»åŠ è´¦æˆ·*',
      parse_mode: 'Markdown',
      reply_markup: getMainKeyboard()
    });
    return;
  }

  try {
    const listUrl = new URL('https://gmail.googleapis.com/gmail/v1/users/me/messages');
    listUrl.searchParams.set('q', query);
    listUrl.searchParams.set('maxResults', PAGE_SIZE.toString());
    if (pageToken) {
      listUrl.searchParams.set('pageToken', pageToken);
    }

    const listResp = await fetch(listUrl, {
      headers: { Authorization: \`Bearer \${tokenData.access_token}\` }
    });

    if (!listResp.ok) {
      throw new Error('è·å–é‚®ä»¶åˆ—è¡¨å¤±è´¥');
    }

    const listData = await listResp.json();
    const messages = listData.messages || [];
    const nextPageToken = listData.nextPageToken;

    if (messages.length === 0) {
      const text = \`ğŸ“­ *\${query}*\\n\\næ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„é‚®ä»¶\`;
      const keyboard = {
        inline_keyboard: [[{ text: 'ğŸ”„ åˆ·æ–°', callback_data: \`refresh:\${query.substring(0, 40)}\` }]]
      };

      if (editMsgId) {
        await telegramAPI(env.BOT_TOKEN, 'editMessageText', {
          chat_id: chatId,
          message_id: editMsgId,
          text,
          parse_mode: 'Markdown',
          reply_markup: keyboard
        });
      } else {
        await telegramAPI(env.BOT_TOKEN, 'sendMessage', {
          chat_id: chatId,
          text,
          parse_mode: 'Markdown',
          reply_markup: keyboard
        });
      }
      return;
    }

    // è·å–é‚®ä»¶æ‘˜è¦
    const summaries = [];
    for (const msg of messages) {
      const detailResp = await fetch(
        \`https://gmail.googleapis.com/gmail/v1/users/me/messages/\${msg.id}?format=metadata&metadataHeaders=From&metadataHeaders=Subject&metadataHeaders=Date\`,
        { headers: { Authorization: \`Bearer \${tokenData.access_token}\` } }
      );

      if (detailResp.ok) {
        const mail = await detailResp.json();
        const headers = mail.payload?.headers || [];
        const getHeader = (name) => headers.find(h => h.name.toLowerCase() === name.toLowerCase())?.value || '';

        let from = getHeader('From');
        const emailMatch = from.match(/[\\w.-]+@[\\w.-]+\\.\\w+/);
        if (emailMatch) {
          from = from.replace(emailMatch[0], '').replace(/[<>"]/g, '').trim() || emailMatch[0];
        }

        let dateStr = '';
        try {
          const d = new Date(getHeader('Date'));
          dateStr = \`\${d.getMonth() + 1}/\${d.getDate()} \${String(d.getHours()).padStart(2, '0')}:\${String(d.getMinutes()).padStart(2, '0')}\`;
        } catch {}

        summaries.push({
          id: msg.id,
          from: from.substring(0, 20),
          subject: (getHeader('Subject') || '(æ— ä¸»é¢˜)').substring(0, 30),
          date: dateStr,
          isUnread: mail.labelIds?.includes('UNREAD'),
          isStarred: mail.labelIds?.includes('STARRED')
        });
      }
    }

    // æ„å»ºæ¶ˆæ¯æ–‡æœ¬
    let text = \`ğŸ“¬ *\${query}*\\n\${'â”'.repeat(20)}\\n\\n\`;
    summaries.forEach((m, i) => {
      const status = m.isUnread ? 'ğŸ”µ' : 'âšªï¸';
      const star = m.isStarred ? 'â­' : '';
      text += \`\${status}\${star} *\${i + 1}.* \${m.subject}\\n    ğŸ“¤ \${m.from} Â· \${m.date}\\n\\n\`;
    });

    // æ„å»ºæŒ‰é’®
    const buttons = [];

    // é‚®ä»¶æŸ¥çœ‹æŒ‰é’®ï¼ˆæ¯è¡Œ3ä¸ªï¼‰
    for (let i = 0; i < summaries.length; i += 3) {
      const row = [];
      for (let j = i; j < Math.min(i + 3, summaries.length); j++) {
        row.push({
          text: \`\${summaries[j].isUnread ? 'ğŸ”µ' : 'ğŸ“§'} \${j + 1}\`,
          callback_data: \`mail:\${summaries[j].id}\`
        });
      }
      buttons.push(row);
    }

    // åˆ†é¡µæŒ‰é’®
    const navRow = [];
    navRow.push({ text: 'ğŸ”„ åˆ·æ–°', callback_data: \`refresh:\${query.substring(0, 40)}\` });
    if (nextPageToken) {
      const pageId = Date.now().toString(36);
      await env.USER_TOKENS.put(\`page:\${userId}:\${pageId}\`, JSON.stringify({
        query,
        token: nextPageToken
      }), { expirationTtl: 3600 });
      navRow.push({ text: 'â¡ï¸ ä¸‹ä¸€é¡µ', callback_data: \`page:\${pageId}\` });
    }
    buttons.push(navRow);

    buttons.push([
      { text: 'âœ… å…¨éƒ¨å·²è¯»', callback_data: 'action:readall' },
      { text: 'ğŸ  èœå•', callback_data: 'action:menu' }
    ]);

    const keyboard = { inline_keyboard: buttons };

    if (editMsgId) {
      await telegramAPI(env.BOT_TOKEN, 'editMessageText', {
        chat_id: chatId,
        message_id: editMsgId,
        text,
        parse_mode: 'Markdown',
        reply_markup: keyboard
      });
    } else {
      await telegramAPI(env.BOT_TOKEN, 'sendMessage', {
        chat_id: chatId,
        text,
        parse_mode: 'Markdown',
        reply_markup: keyboard
      });
    }
  } catch (error) {
    console.error('Mail list error:', error);
    await telegramAPI(env.BOT_TOKEN, 'sendMessage', {
      chat_id: chatId,
      text: \`âŒ è·å–é‚®ä»¶å¤±è´¥: \${error.message}\`,
      reply_markup: getMainKeyboard()
    });
  }
}

// ==================== é‚®ä»¶è¯¦æƒ… ====================
async function handleMailDetail(chatId, userId, mailId, editMsgId, showFull, env) {
  const tokenData = await getActiveToken(userId, env);
  if (!tokenData) return;

  try {
    const detailResp = await fetch(
      \`https://gmail.googleapis.com/gmail/v1/users/me/messages/\${mailId}?format=full\`,
      { headers: { Authorization: \`Bearer \${tokenData.access_token}\` } }
    );

    if (!detailResp.ok) {
      throw new Error('è·å–é‚®ä»¶å¤±è´¥');
    }

    const mail = await detailResp.json();
    const headers = mail.payload?.headers || [];
    const getHeader = (name) => headers.find(h => h.name.toLowerCase() === name.toLowerCase())?.value || '';

    const from = getHeader('From');
    const subject = getHeader('Subject') || '(æ— ä¸»é¢˜)';
    const date = getHeader('Date');
    const isUnread = mail.labelIds?.includes('UNREAD');
    const isStarred = mail.labelIds?.includes('STARRED');

    // è§£æå‘ä»¶äºº
    let fromName = from;
    let fromEmail = from;
    const emailMatch = from.match(/[\\w.-]+@[\\w.-]+\\.\\w+/);
    if (emailMatch) {
      fromEmail = emailMatch[0];
      fromName = from.replace(emailMatch[0], '').replace(/[<>"]/g, '').trim() || fromEmail;
    }

    // æ ¼å¼åŒ–æ—¥æœŸ
    let dateStr = date;
    try {
      const d = new Date(date);
      dateStr = \`\${d.getMonth() + 1}/\${d.getDate()} \${String(d.getHours()).padStart(2, '0')}:\${String(d.getMinutes()).padStart(2, '0')}\`;
    } catch {}

    // æå–å†…å®¹
    const content = extractEmailContent(mail.payload, showFull ? MAX_CONTENT_LENGTH : PREVIEW_LENGTH);
    const attachments = detectAttachments(mail.payload);

    // æ„å»ºæ¶ˆæ¯
    let text = \`\${isUnread ? 'ğŸ”µ æœªè¯»' : 'âšªï¸ å·²è¯»'}\${isStarred ? ' â­' : ''} | *\${subject}*\\n\${'â”'.repeat(20)}\\n\`;
    text += \`ğŸ‘¤ \${fromName}\\nğŸ“§ \${fromEmail}\\nğŸ• \${dateStr}\\n\`;
    if (attachments.length > 0) {
      text += \`ğŸ“ é™„ä»¶ (\${attachments.length})\\n\`;
    }
    text += \`\${'â”'.repeat(20)}\\n\\n\${content}\`;

    // æ„å»ºæŒ‰é’®
    const buttons = [];

    // ä¸»æ“ä½œæŒ‰é’®
    buttons.push([
      { text: isUnread ? 'âœ… å·²è¯»' : 'ğŸ“© æœªè¯»', callback_data: \`\${isUnread ? 'read' : 'unread'}:\${mailId}\` },
      { text: isStarred ? 'â­ å–æ¶ˆ' : 'â­ æ˜Ÿæ ‡', callback_data: \`\${isStarred ? 'unstar' : 'star'}:\${mailId}\` }
    ]);

    // æ›´å¤šæ“ä½œ
    const moreRow = [];
    if (!showFull && content.length >= PREVIEW_LENGTH) {
      moreRow.push({ text: 'ğŸ“– æŸ¥çœ‹å®Œæ•´', callback_data: \`full:\${mailId}\` });
    }
    moreRow.push({ text: 'ğŸ—‘ï¸ åˆ é™¤', callback_data: \`delete:\${mailId}\` });
    buttons.push(moreRow);

    // æœç´¢å‘ä»¶äºº
    buttons.push([{
      text: \`ğŸ” æœç´¢ \${fromName.substring(0, 10)} çš„é‚®ä»¶\`,
      callback_data: \`search:from:\${fromEmail.substring(0, 30)}\`
    }]);

    // é™„ä»¶æŒ‰é’®
    if (attachments.length > 0) {
      const attRow = [];
      for (let i = 0; i < Math.min(attachments.length, 3); i++) {
        attRow.push({
          text: \`ğŸ“ \${attachments[i].name.substring(0, 10)}\`,
          callback_data: \`att:\${mailId}:\${i}\`
        });
      }
      buttons.push(attRow);
    }

    buttons.push([{ text: 'â¬…ï¸ è¿”å›åˆ—è¡¨', callback_data: 'action:back' }]);

    const keyboard = { inline_keyboard: buttons };

    if (editMsgId) {
      await telegramAPI(env.BOT_TOKEN, 'editMessageText', {
        chat_id: chatId,
        message_id: editMsgId,
        text,
        parse_mode: 'Markdown',
        reply_markup: keyboard
      });
    } else {
      await telegramAPI(env.BOT_TOKEN, 'sendMessage', {
        chat_id: chatId,
        text,
        parse_mode: 'Markdown',
        reply_markup: keyboard
      });
    }
  } catch (error) {
    console.error('Mail detail error:', error);
    await telegramAPI(env.BOT_TOKEN, 'sendMessage', {
      chat_id: chatId,
      text: \`âŒ è·å–é‚®ä»¶è¯¦æƒ…å¤±è´¥: \${error.message}\`
    });
  }
}

// æå–é‚®ä»¶å†…å®¹
function extractEmailContent(payload, maxLength) {
  let bodyData = null;

  function findBody(part, mimeType) {
    if (part.mimeType === mimeType && part.body?.data) {
      return part.body.data;
    }
    if (part.parts) {
      for (const p of part.parts) {
        const result = findBody(p, mimeType);
        if (result) return result;
      }
    }
    return null;
  }

  bodyData = findBody(payload, 'text/plain') || findBody(payload, 'text/html') || payload.body?.data;

  if (!bodyData) return '(æ— å†…å®¹)';

  try {
    const base64 = bodyData.replace(/-/g, '+').replace(/_/g, '/');
    const binary = atob(base64);
    const bytes = new Uint8Array(binary.length);
    for (let i = 0; i < binary.length; i++) {
      bytes[i] = binary.charCodeAt(i);
    }
    let text = new TextDecoder('utf-8').decode(bytes);

    // å¤„ç† HTML
    text = text.replace(/<style[^>]*>[\\s\\S]*?<\\/style>/gi, '');
    text = text.replace(/<script[^>]*>[\\s\\S]*?<\\/script>/gi, '');
    text = text.replace(/<br\\s*\\/?>/gi, '\\n');
    text = text.replace(/<\\/p>/gi, '\\n');
    text = text.replace(/<\\/div>/gi, '\\n');
    text = text.replace(/<\\/tr>/gi, '\\n');
    text = text.replace(/<\\/li>/gi, '\\n');
    text = text.replace(/<[^>]*>/g, '');

    // è§£ç  HTML å®ä½“
    text = text.replace(/&nbsp;/gi, ' ');
    text = text.replace(/&amp;/gi, '&');
    text = text.replace(/&lt;/gi, '<');
    text = text.replace(/&gt;/gi, '>');
    text = text.replace(/&quot;/gi, '"');

    // æ¸…ç†ç©ºç™½
    text = text.replace(/[ \\t]+/g, ' ');
    text = text.replace(/\\n\\s*\\n/g, '\\n\\n');
    text = text.trim();

    if (text.length > maxLength) {
      text = text.substring(0, maxLength) + '\\n\\n... (ç‚¹å‡»æŸ¥çœ‹å®Œæ•´)';
    }

    return text || '(æ— å†…å®¹)';
  } catch (e) {
    return '(æ— æ³•è§£æå†…å®¹)';
  }
}

// æ£€æµ‹é™„ä»¶
function detectAttachments(payload) {
  const attachments = [];

  function scan(part) {
    if (part.filename && part.body?.attachmentId) {
      attachments.push({
        name: part.filename,
        mimeType: part.mimeType,
        size: part.body.size || 0,
        attachmentId: part.body.attachmentId
      });
    }
    if (part.parts) {
      part.parts.forEach(scan);
    }
  }

  scan(payload);
  return attachments;
}

// ==================== é‚®ç®±ç»Ÿè®¡ ====================
async function handleStats(chatId, userId, editMsgId, env) {
  const tokenData = await getActiveToken(userId, env);
  if (!tokenData) {
    await telegramAPI(env.BOT_TOKEN, 'sendMessage', {
      chat_id: chatId,
      text: 'âš ï¸ è¯·å…ˆç»‘å®š Gmail è´¦æˆ·',
      reply_markup: getMainKeyboard()
    });
    return;
  }

  try {
    const today = getTodayDate();
    const accessToken = tokenData.access_token;

    const [profileResp, unreadResp, todayResp, starredResp] = await Promise.all([
      fetch('https://gmail.googleapis.com/gmail/v1/users/me/profile', {
        headers: { Authorization: \`Bearer \${accessToken}\` }
      }),
      fetch('https://gmail.googleapis.com/gmail/v1/users/me/messages?q=is:unread&maxResults=1', {
        headers: { Authorization: \`Bearer \${accessToken}\` }
      }),
      fetch(\`https://gmail.googleapis.com/gmail/v1/users/me/messages?q=after:\${today}&maxResults=1\`, {
        headers: { Authorization: \`Bearer \${accessToken}\` }
      }),
      fetch('https://gmail.googleapis.com/gmail/v1/users/me/messages?q=is:starred&maxResults=1', {
        headers: { Authorization: \`Bearer \${accessToken}\` }
      })
    ]);

    const profile = await profileResp.json();
    const unread = await unreadResp.json();
    const todayMail = await todayResp.json();
    const starred = await starredResp.json();

    let text = 'ğŸ“Š *é‚®ç®±ç»Ÿè®¡*\\n' + 'â”'.repeat(20) + '\\n\\n';
    text += \`ğŸ“§ \${profile.emailAddress || 'N/A'}\\n\\n\`;
    text += \`ğŸ“¬ æœªè¯»é‚®ä»¶: *\${unread.resultSizeEstimate || 0}*\\n\`;
    text += \`ğŸ“… ä»Šæ—¥é‚®ä»¶: *\${todayMail.resultSizeEstimate || 0}*\\n\`;
    text += \`â­ æ˜Ÿæ ‡é‚®ä»¶: *\${starred.resultSizeEstimate || 0}*\\n\`;
    text += \`ğŸ“ é‚®ä»¶æ€»æ•°: *\${profile.messagesTotal || 0}*\\n\`;

    const keyboard = {
      inline_keyboard: [
        [
          { text: 'ğŸ“¬ æŸ¥çœ‹æœªè¯»', callback_data: 'search:is:unread' },
          { text: 'ğŸ“… æŸ¥çœ‹ä»Šæ—¥', callback_data: \`search:after:\${today}\` }
        ],
        [
          { text: 'â­ æŸ¥çœ‹æ˜Ÿæ ‡', callback_data: 'search:is:starred' },
          { text: 'ğŸ”„ åˆ·æ–°', callback_data: 'stats:refresh' }
        ]
      ]
    };

    if (editMsgId) {
      await telegramAPI(env.BOT_TOKEN, 'editMessageText', {
        chat_id: chatId,
        message_id: editMsgId,
        text,
        parse_mode: 'Markdown',
        reply_markup: keyboard
      });
    } else {
      await telegramAPI(env.BOT_TOKEN, 'sendMessage', {
        chat_id: chatId,
        text,
        parse_mode: 'Markdown',
        reply_markup: keyboard
      });
    }
  } catch (error) {
    console.error('Stats error:', error);
    await telegramAPI(env.BOT_TOKEN, 'sendMessage', {
      chat_id: chatId,
      text: \`âŒ è·å–ç»Ÿè®¡å¤±è´¥: \${error.message}\`,
      reply_markup: getMainKeyboard()
    });
  }
}

// ==================== æ‰¹é‡å·²è¯» ====================
async function handleMarkAllRead(chatId, userId, env) {
  const tokenData = await getActiveToken(userId, env);
  if (!tokenData) {
    await telegramAPI(env.BOT_TOKEN, 'sendMessage', {
      chat_id: chatId,
      text: 'âš ï¸ è¯·å…ˆç»‘å®š Gmail è´¦æˆ·',
      reply_markup: getMainKeyboard()
    });
    return;
  }

  try {
    // è·å–æœªè¯»é‚®ä»¶
    const listResp = await fetch(
      'https://gmail.googleapis.com/gmail/v1/users/me/messages?q=is:unread&maxResults=100',
      { headers: { Authorization: \`Bearer \${tokenData.access_token}\` } }
    );
    const listData = await listResp.json();
    const messages = listData.messages || [];

    if (messages.length === 0) {
      await telegramAPI(env.BOT_TOKEN, 'sendMessage', {
        chat_id: chatId,
        text: 'âœ… æ²¡æœ‰æœªè¯»é‚®ä»¶',
        reply_markup: getMainKeyboard()
      });
      return;
    }

    // æ‰¹é‡æ ‡è®°å·²è¯»
    await fetch('https://gmail.googleapis.com/gmail/v1/users/me/messages/batchModify', {
      method: 'POST',
      headers: {
        Authorization: \`Bearer \${tokenData.access_token}\`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        ids: messages.map(m => m.id),
        removeLabelIds: ['UNREAD']
      })
    });

    await telegramAPI(env.BOT_TOKEN, 'sendMessage', {
      chat_id: chatId,
      text: \`âœ… å·²å°† *\${messages.length}* å°é‚®ä»¶æ ‡è®°ä¸ºå·²è¯»\`,
      parse_mode: 'Markdown',
      reply_markup: getMainKeyboard()
    });
  } catch (error) {
    console.error('Mark all read error:', error);
    await telegramAPI(env.BOT_TOKEN, 'sendMessage', {
      chat_id: chatId,
      text: \`âŒ æ“ä½œå¤±è´¥: \${error.message}\`,
      reply_markup: getMainKeyboard()
    });
  }
}

// ==================== å›è°ƒå¤„ç† ====================
async function handleCallbackQuery(query, env, origin) {
  const chatId = query.message.chat.id;
  const userId = query.from.id.toString();
  const msgId = query.message.message_id;
  const data = query.data;

  await telegramAPI(env.BOT_TOKEN, 'answerCallbackQuery', {
    callback_query_id: query.id
  });

  // è´¦æˆ·ç®¡ç†
  if (data === 'account:add') {
    await sendLoginLink(chatId, userId, origin, env);
    return;
  }

  if (data === 'account:refresh') {
    await handleAccountManage(chatId, userId, msgId, env);
    return;
  }

  if (data === 'account:delete_menu') {
    const accounts = await getAccountList(userId, env);
    if (accounts.length === 0) {
      await telegramAPI(env.BOT_TOKEN, 'answerCallbackQuery', {
        callback_query_id: query.id,
        text: 'æ²¡æœ‰å¯åˆ é™¤çš„è´¦æˆ·',
        show_alert: true
      });
      return;
    }

    const buttons = accounts.map(email => ([{
      text: \`ğŸ—‘ï¸ \${email}\`,
      callback_data: \`delaccount:\${email.substring(0, 50)}\`
    }]));
    buttons.push([{ text: 'â¬…ï¸ è¿”å›', callback_data: 'account:refresh' }]);

    await telegramAPI(env.BOT_TOKEN, 'editMessageText', {
      chat_id: chatId,
      message_id: msgId,
      text: 'ğŸ—‘ï¸ *é€‰æ‹©è¦åˆ é™¤çš„è´¦æˆ·*\\n\\nåˆ é™¤åéœ€è¦é‡æ–°æˆæƒ',
      parse_mode: 'Markdown',
      reply_markup: { inline_keyboard: buttons }
    });
    return;
  }

  if (data.startsWith('delaccount:')) {
    const email = data.substring(11);
    await env.USER_TOKENS.delete(\`token:\${userId}:\${email}\`);
    await env.USER_TOKENS.delete(\`push:\${userId}:\${email}\`);

    let accounts = await getAccountList(userId, env);
    accounts = accounts.filter(e => e !== email);
    await env.USER_TOKENS.put(\`accounts:\${userId}\`, JSON.stringify(accounts));

    const activeEmail = await env.USER_TOKENS.get(\`active:\${userId}\`);
    if (activeEmail === email) {
      await env.USER_TOKENS.put(\`active:\${userId}\`, accounts[0] || '');
    }

    await handleAccountManage(chatId, userId, msgId, env);
    return;
  }

  if (data.startsWith('switch:')) {
    const email = data.substring(7);
    await env.USER_TOKENS.put(\`active:\${userId}\`, email);
    await handleAccountManage(chatId, userId, msgId, env);
    return;
  }

  // ç»Ÿè®¡åˆ·æ–°
  if (data === 'stats:refresh') {
    await handleStats(chatId, userId, msgId, env);
    return;
  }

  // æ¨é€å¼€å…³
  if (data === 'push:enable' || data === 'push:disable') {
    const activeEmail = await env.USER_TOKENS.get(\`active:\${userId}\`);
    if (!activeEmail) return;

    const enable = data === 'push:enable';

    if (enable && env.PUBSUB_TOPIC) {
      const tokenData = await getActiveToken(userId, env);
      if (tokenData) {
        try {
          const watchResp = await fetch('https://gmail.googleapis.com/gmail/v1/users/me/watch', {
            method: 'POST',
            headers: {
              Authorization: \`Bearer \${tokenData.access_token}\`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              topicName: env.PUBSUB_TOPIC,
              labelIds: ['INBOX']
            })
          });
          const watchData = await watchResp.json();

          await env.USER_TOKENS.put(\`push:\${userId}:\${activeEmail}\`, JSON.stringify({
            enabled: true,
            historyId: watchData.historyId,
            watchExpiry: parseInt(watchData.expiration)
          }));
        } catch (e) {
          console.error('Watch error:', e);
        }
      }
    } else {
      await env.USER_TOKENS.put(\`push:\${userId}:\${activeEmail}\`, JSON.stringify({ enabled: false }));
    }

    await sendSettings(chatId, userId, env);
    return;
  }

  // æ“ä½œå¤„ç†
  if (data.startsWith('action:')) {
    const action = data.split(':')[1];
    switch (action) {
      case 'menu':
        await sendWelcome(chatId, userId, env);
        break;
      case 'back':
        await handleMailList(chatId, userId, 'in:inbox', null, msgId, env);
        break;
      case 'readall':
        await handleMarkAllRead(chatId, userId, env);
        break;
      case 'search_help':
        await sendSearchHelp(chatId, env);
        break;
    }
    return;
  }

  // éœ€è¦ Token çš„æ“ä½œ
  const tokenData = await getActiveToken(userId, env);
  if (!tokenData) {
    await telegramAPI(env.BOT_TOKEN, 'answerCallbackQuery', {
      callback_query_id: query.id,
      text: 'è¯·å…ˆç»‘å®šè´¦æˆ·',
      show_alert: true
    });
    return;
  }

  // åˆ·æ–°åˆ—è¡¨
  if (data.startsWith('refresh:')) {
    const q = data.substring(8);
    await handleMailList(chatId, userId, q || 'in:inbox', null, msgId, env);
    return;
  }

  // ç¿»é¡µ
  if (data.startsWith('page:')) {
    const pageId = data.split(':')[1];
    const pageData = await env.USER_TOKENS.get(\`page:\${userId}:\${pageId}\`, { type: 'json' });
    if (pageData) {
      await handleMailList(chatId, userId, pageData.query, pageData.token, msgId, env);
    }
    return;
  }

  // æŸ¥çœ‹é‚®ä»¶
  if (data.startsWith('mail:')) {
    const mailId = data.split(':')[1];
    await handleMailDetail(chatId, userId, mailId, msgId, false, env);
    return;
  }

  // æŸ¥çœ‹å®Œæ•´
  if (data.startsWith('full:')) {
    const mailId = data.split(':')[1];
    await handleMailDetail(chatId, userId, mailId, msgId, true, env);
    return;
  }

  // æœç´¢
  if (data.startsWith('search:')) {
    const q = data.substring(7);
    await handleMailList(chatId, userId, q, null, msgId, env);
    return;
  }

  // æ ‡è®°å·²è¯»
  if (data.startsWith('read:')) {
    const mailId = data.split(':')[1];
    await fetch(\`https://gmail.googleapis.com/gmail/v1/users/me/messages/\${mailId}/modify\`, {
      method: 'POST',
      headers: {
        Authorization: \`Bearer \${tokenData.access_token}\`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ removeLabelIds: ['UNREAD'] })
    });
    await handleMailDetail(chatId, userId, mailId, msgId, false, env);
    return;
  }

  // æ ‡è®°æœªè¯»
  if (data.startsWith('unread:')) {
    const mailId = data.split(':')[1];
    await fetch(\`https://gmail.googleapis.com/gmail/v1/users/me/messages/\${mailId}/modify\`, {
      method: 'POST',
      headers: {
        Authorization: \`Bearer \${tokenData.access_token}\`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ addLabelIds: ['UNREAD'] })
    });
    await handleMailDetail(chatId, userId, mailId, msgId, false, env);
    return;
  }

  // åŠ æ˜Ÿæ ‡
  if (data.startsWith('star:')) {
    const mailId = data.split(':')[1];
    await fetch(\`https://gmail.googleapis.com/gmail/v1/users/me/messages/\${mailId}/modify\`, {
      method: 'POST',
      headers: {
        Authorization: \`Bearer \${tokenData.access_token}\`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ addLabelIds: ['STARRED'] })
    });
    await handleMailDetail(chatId, userId, mailId, msgId, false, env);
    return;
  }

  // å–æ¶ˆæ˜Ÿæ ‡
  if (data.startsWith('unstar:')) {
    const mailId = data.split(':')[1];
    await fetch(\`https://gmail.googleapis.com/gmail/v1/users/me/messages/\${mailId}/modify\`, {
      method: 'POST',
      headers: {
        Authorization: \`Bearer \${tokenData.access_token}\`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ removeLabelIds: ['STARRED'] })
    });
    await handleMailDetail(chatId, userId, mailId, msgId, false, env);
    return;
  }

  // åˆ é™¤é‚®ä»¶
  if (data.startsWith('delete:')) {
    const mailId = data.split(':')[1];
    await fetch(\`https://gmail.googleapis.com/gmail/v1/users/me/messages/\${mailId}/trash\`, {
      method: 'POST',
      headers: { Authorization: \`Bearer \${tokenData.access_token}\` }
    });

    await telegramAPI(env.BOT_TOKEN, 'editMessageText', {
      chat_id: chatId,
      message_id: msgId,
      text: 'ğŸ—‘ï¸ é‚®ä»¶å·²ç§»è‡³åƒåœ¾ç®±',
      reply_markup: {
        inline_keyboard: [[{ text: 'â¬…ï¸ è¿”å›åˆ—è¡¨', callback_data: 'action:back' }]]
      }
    });
    return;
  }

  // ä¸‹è½½é™„ä»¶
  if (data.startsWith('att:')) {
    const parts = data.split(':');
    const mailId = parts[1];
    const attIndex = parseInt(parts[2]);

    try {
      const mailResp = await fetch(
        \`https://gmail.googleapis.com/gmail/v1/users/me/messages/\${mailId}?format=full\`,
        { headers: { Authorization: \`Bearer \${tokenData.access_token}\` } }
      );
      const mail = await mailResp.json();
      const attachments = detectAttachments(mail.payload);
      const att = attachments[attIndex];

      if (!att) {
        await telegramAPI(env.BOT_TOKEN, 'answerCallbackQuery', {
          callback_query_id: query.id,
          text: 'é™„ä»¶ä¸å­˜åœ¨',
          show_alert: true
        });
        return;
      }

      if (att.size > MAX_ATTACHMENT_SIZE) {
        await telegramAPI(env.BOT_TOKEN, 'answerCallbackQuery', {
          callback_query_id: query.id,
          text: 'é™„ä»¶è¿‡å¤§ï¼ˆ>20MBï¼‰',
          show_alert: true
        });
        return;
      }

      const attResp = await fetch(
        \`https://gmail.googleapis.com/gmail/v1/users/me/messages/\${mailId}/attachments/\${att.attachmentId}\`,
        { headers: { Authorization: \`Bearer \${tokenData.access_token}\` } }
      );
      const attData = await attResp.json();

      const base64 = attData.data.replace(/-/g, '+').replace(/_/g, '/');
      const binary = atob(base64);
      const bytes = new Uint8Array(binary.length);
      for (let i = 0; i < binary.length; i++) {
        bytes[i] = binary.charCodeAt(i);
      }

      const formData = new FormData();
      formData.append('chat_id', chatId);
      formData.append('document', new Blob([bytes], { type: att.mimeType }), att.name);

      await fetch(\`https://api.telegram.org/bot\${env.BOT_TOKEN}/sendDocument\`, {
        method: 'POST',
        body: formData
      });
    } catch (e) {
      console.error('Attachment error:', e);
      await telegramAPI(env.BOT_TOKEN, 'sendMessage', {
        chat_id: chatId,
        text: \`âŒ ä¸‹è½½é™„ä»¶å¤±è´¥: \${e.message}\`
      });
    }
    return;
  }
}

// ==================== é¦–é¡µ ====================
function generateHomePage() {
  return \`<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gmail Telegram Bot</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
    }
    .container { text-align: center; padding: 40px; }
    .emoji { font-size: 4rem; margin-bottom: 1rem; }
    h1 { font-size: 2.5rem; margin-bottom: 0.5rem; }
    p { opacity: 0.9; margin-bottom: 1.5rem; }
    .status {
      display: inline-block;
      background: rgba(255,255,255,0.2);
      padding: 12px 24px;
      border-radius: 50px;
      font-weight: 500;
    }
    .features {
      display: flex;
      gap: 1rem;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 2rem;
    }
    .feature {
      background: rgba(255,255,255,0.1);
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="emoji">ğŸ“§ğŸ¤–</div>
    <h1>Gmail Telegram Bot</h1>
    <p>é€šè¿‡ Telegram å®‰å…¨è®¿é—®æ‚¨çš„ Gmail é‚®ç®±</p>
    <div class="status">âœ… æœåŠ¡è¿è¡Œä¸­</div>
    <div class="features">
      <span class="feature">ğŸ”’ OAuth è®¤è¯</span>
      <span class="feature">ğŸ‘¥ å¤šè´¦æˆ·</span>
      <span class="feature">ğŸ”” å®æ—¶æ¨é€</span>
      <span class="feature">ğŸ“ é™„ä»¶ä¸‹è½½</span>
    </div>
  </div>
</body>
</html>\`;
}`;

    // å¡«å……ä»£ç 
    document.getElementById('workerCode').textContent = workerCode;
    if (typeof Prism !== 'undefined') {
      Prism.highlightAll();
    }

    // å¤åˆ¶åŠŸèƒ½
    document.getElementById('copyBtn').addEventListener('click', async () => {
      const btn = document.getElementById('copyBtn');
      const icon = document.getElementById('copyIcon');
      const text = document.getElementById('copyText');

      try {
        await navigator.clipboard.writeText(workerCode);
        icon.textContent = 'âœ…';
        text.textContent = 'å·²å¤åˆ¶!';
        btn.classList.remove('bg-purple-600', 'hover:bg-purple-700');
        btn.classList.add('bg-green-600');

        setTimeout(() => {
          icon.textContent = 'ğŸ“‹';
          text.textContent = 'å¤åˆ¶ä»£ç ';
          btn.classList.remove('bg-green-600');
          btn.classList.add('bg-purple-600', 'hover:bg-purple-700');
        }, 2000);
      } catch (err) {
        // Fallback
        const textarea = document.createElement('textarea');
        textarea.value = workerCode;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);

        icon.textContent = 'âœ…';
        text.textContent = 'å·²å¤åˆ¶!';
      }
    });
  </script>
</body>
</html>
