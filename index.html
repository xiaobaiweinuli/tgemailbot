<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gmail Telegram Bot - Cloudflare Worker éƒ¨ç½²æŒ‡å—</title>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
  <style>
    .gradient-bg {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .code-container {
      max-height: 600px;
      overflow-y: auto;
    }
    pre[class*="language-"] {
      margin: 0;
      border-radius: 0.5rem;
    }
    .step-number {
      width: 32px;
      height: 32px;
      min-width: 32px;
    }
    .copy-btn:active {
      transform: scale(0.95);
    }
  </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
  <!-- Header -->
  <header class="gradient-bg py-12 px-4">
    <div class="max-w-5xl mx-auto text-center">
      <div class="flex items-center justify-center gap-4 mb-4">
        <span class="text-5xl">ğŸ“§</span>
        <span class="text-5xl">ğŸ¤–</span>
      </div>
      <h1 class="text-4xl md:text-5xl font-bold mb-4">Gmail Telegram Bot</h1>
      <p class="text-xl text-purple-100 max-w-2xl mx-auto">
        åŸºäº Cloudflare Workers çš„ Telegram Botï¼Œå®‰å…¨è®¿é—® Gmail é‚®ç®±
      </p>
      <div class="flex flex-wrap justify-center gap-3 mt-6">
        <span class="bg-white/20 px-3 py-1 rounded-full text-sm">âœ¨ å®Œå…¨å…è´¹</span>
        <span class="bg-white/20 px-3 py-1 rounded-full text-sm">ğŸ”’ OAuth å®‰å…¨è®¤è¯</span>
        <span class="bg-white/20 px-3 py-1 rounded-full text-sm">âš¡ æŒ‰éœ€è§¦å‘</span>
        <span class="bg-white/20 px-3 py-1 rounded-full text-sm">ğŸŒ æ— éœ€æœåŠ¡å™¨</span>
      </div>
    </div>
  </header>

  <main class="max-w-5xl mx-auto px-4 py-12">
    <!-- Features -->
    <section class="mb-16">
      <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
        <span class="text-purple-400">ğŸš€</span> åŠŸèƒ½ç‰¹æ€§
      </h2>
      <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
        <div class="bg-gray-800 rounded-xl p-5 border border-gray-700">
          <div class="text-2xl mb-2">ğŸ“¬</div>
          <h3 class="font-semibold mb-1">åˆ†é¡µæµè§ˆé‚®ä»¶</h3>
          <p class="text-gray-400 text-sm">æ”¯æŒä¸Šä¸€é¡µ/ä¸‹ä¸€é¡µç¿»é¡µï¼Œæ¯é¡µæ˜¾ç¤º5å°é‚®ä»¶æ‘˜è¦</p>
        </div>
        <div class="bg-gray-800 rounded-xl p-5 border border-gray-700">
          <div class="text-2xl mb-2">ğŸ”</div>
          <h3 class="font-semibold mb-1">æ™ºèƒ½æœç´¢</h3>
          <p class="text-gray-400 text-sm">æ”¯æŒ Gmail æœç´¢è¯­æ³•ï¼Œå¿«æ·æŒ‰é’®ä¸€é”®æœç´¢</p>
        </div>
        <div class="bg-gray-800 rounded-xl p-5 border border-gray-700">
          <div class="text-2xl mb-2">ğŸ“Š</div>
          <h3 class="font-semibold mb-1">é‚®ç®±ç»Ÿè®¡</h3>
          <p class="text-gray-400 text-sm">æŸ¥çœ‹æœªè¯»æ•°ã€ä»Šæ—¥é‚®ä»¶ã€æ˜Ÿæ ‡æ•°é‡ç­‰ç»Ÿè®¡</p>
        </div>
        <div class="bg-gray-800 rounded-xl p-5 border border-gray-700">
          <div class="text-2xl mb-2">ğŸ“</div>
          <h3 class="font-semibold mb-1">é™„ä»¶ä¸‹è½½</h3>
          <p class="text-gray-400 text-sm">ç›´æ¥ä¸‹è½½é‚®ä»¶é™„ä»¶åˆ° Telegramï¼ˆâ‰¤15MBï¼‰</p>
        </div>
        <div class="bg-gray-800 rounded-xl p-5 border border-gray-700">
          <div class="text-2xl mb-2">âœ…</div>
          <h3 class="font-semibold mb-1">é‚®ä»¶æ“ä½œ</h3>
          <p class="text-gray-400 text-sm">æ ‡è®°å·²è¯»/æœªè¯»ã€åˆ é™¤é‚®ä»¶ã€åŠ æ˜Ÿæ ‡ç­‰æ“ä½œ</p>
        </div>
        <div class="bg-gray-800 rounded-xl p-5 border border-gray-700">
          <div class="text-2xl mb-2">ğŸ‘¤</div>
          <h3 class="font-semibold mb-1">å‘ä»¶äººæœç´¢</h3>
          <p class="text-gray-400 text-sm">ç‚¹å‡»å‘ä»¶äººå¿«é€Ÿæœç´¢ TA çš„æ‰€æœ‰é‚®ä»¶</p>
        </div>
        <div class="bg-gray-800 rounded-xl p-5 border border-gray-700">
          <div class="text-2xl mb-2">ğŸ“…</div>
          <h3 class="font-semibold mb-1">ä»Šæ—¥é‚®ä»¶</h3>
          <p class="text-gray-400 text-sm">ä¸€é”®æŸ¥çœ‹ä»Šå¤©æ”¶åˆ°çš„æ‰€æœ‰é‚®ä»¶</p>
        </div>
        <div class="bg-gray-800 rounded-xl p-5 border border-gray-700">
          <div class="text-2xl mb-2">ğŸ”</div>
          <h3 class="font-semibold mb-1">å®‰å…¨è®¤è¯</h3>
          <p class="text-gray-400 text-sm">ä½¿ç”¨ Google OAuth 2.0ï¼Œæ— éœ€æä¾›è´¦å·å¯†ç </p>
        </div>
        <div class="bg-gray-800 rounded-xl p-5 border border-gray-700">
          <div class="text-2xl mb-2">ğŸ”„</div>
          <h3 class="font-semibold mb-1">è‡ªåŠ¨åˆ·æ–° Token</h3>
          <p class="text-gray-400 text-sm">Token è¿‡æœŸè‡ªåŠ¨åˆ·æ–°ï¼Œæ— éœ€é‡å¤ç™»å½•</p>
        </div>
      </div>
    </section>

    <!-- Commands -->
    <section class="mb-16">
      <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
        <span class="text-purple-400">ğŸ’¬</span> æ”¯æŒçš„å‘½ä»¤
      </h2>
      <div class="bg-gray-800 rounded-xl border border-gray-700 overflow-hidden">
        <table class="w-full">
          <thead class="bg-gray-700/50">
            <tr>
              <th class="text-left px-5 py-3 font-semibold">å‘½ä»¤</th>
              <th class="text-left px-5 py-3 font-semibold">è¯´æ˜</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-700">
            <tr><td class="px-5 py-3 font-mono text-purple-400">/start</td><td class="px-5 py-3 text-gray-300">æ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯å’ŒåŠŸèƒ½èœå•</td></tr>
            <tr><td class="px-5 py-3 font-mono text-purple-400">/login</td><td class="px-5 py-3 text-gray-300">ç™»å½• Gmailï¼ˆæ˜¾ç¤ºæˆæƒæŒ‰é’®ï¼‰</td></tr>
            <tr><td class="px-5 py-3 font-mono text-purple-400">/new</td><td class="px-5 py-3 text-gray-300">è·å–æœªè¯»é‚®ä»¶åˆ—è¡¨ï¼ˆæ”¯æŒåˆ†é¡µï¼‰</td></tr>
            <tr><td class="px-5 py-3 font-mono text-purple-400">/today</td><td class="px-5 py-3 text-gray-300">ä»Šæ—¥æ”¶åˆ°çš„é‚®ä»¶</td></tr>
            <tr><td class="px-5 py-3 font-mono text-purple-400">/stats</td><td class="px-5 py-3 text-gray-300">é‚®ç®±ç»Ÿè®¡ä¿¡æ¯</td></tr>
            <tr><td class="px-5 py-3 font-mono text-purple-400">/search å…³é”®è¯</td><td class="px-5 py-3 text-gray-300">æœç´¢é‚®ä»¶ï¼ˆæ”¯æŒ Gmail è¯­æ³•ï¼‰</td></tr>
            <tr><td class="px-5 py-3 font-mono text-purple-400">/logout</td><td class="px-5 py-3 text-gray-300">é€€å‡ºç™»å½•ï¼Œåˆ é™¤ Token</td></tr>
            <tr><td class="px-5 py-3 font-mono text-purple-400">/help</td><td class="px-5 py-3 text-gray-300">æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- Deployment Steps -->
    <section class="mb-16">
      <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
        <span class="text-purple-400">ğŸ“‹</span> éƒ¨ç½²æ­¥éª¤
      </h2>
      
      <div class="space-y-6">
        <!-- Step 1 -->
        <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
          <div class="flex gap-4">
            <div class="step-number bg-purple-600 rounded-full flex items-center justify-center font-bold shrink-0">1</div>
            <div class="flex-1">
              <h3 class="font-bold text-lg mb-2">åˆ›å»º Telegram Bot</h3>
              <ol class="list-decimal list-inside text-gray-300 space-y-1 ml-1">
                <li>åœ¨ Telegram æœç´¢ <code class="bg-gray-700 px-2 py-0.5 rounded">@BotFather</code></li>
                <li>å‘é€ <code class="bg-gray-700 px-2 py-0.5 rounded">/newbot</code> åˆ›å»ºæ–° Bot</li>
                <li>æŒ‰æç¤ºè®¾ç½®åç§°ï¼Œè·å– <code class="bg-purple-700/50 px-2 py-0.5 rounded text-purple-300">BOT_TOKEN</code></li>
              </ol>
            </div>
          </div>
        </div>

        <!-- Step 2 -->
        <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
          <div class="flex gap-4">
            <div class="step-number bg-purple-600 rounded-full flex items-center justify-center font-bold shrink-0">2</div>
            <div class="flex-1">
              <h3 class="font-bold text-lg mb-2">åˆ›å»º Google OAuth å‡­è¯</h3>
              <ol class="list-decimal list-inside text-gray-300 space-y-2 ml-1">
                <li>è®¿é—® <a href="https://console.cloud.google.com/apis/credentials" target="_blank" class="text-purple-400 hover:underline">Google Cloud Console</a></li>
                <li>åˆ›å»ºé¡¹ç›®ï¼ˆå¦‚å·²æœ‰å¯è·³è¿‡ï¼‰</li>
                <li>åˆ›å»º OAuth 2.0 å®¢æˆ·ç«¯ IDï¼ˆé€‰æ‹© Web åº”ç”¨ç±»å‹ï¼‰</li>
                <li>æ·»åŠ æˆæƒé‡å®šå‘ URIï¼š
                  <code class="block bg-gray-700 px-3 py-2 rounded mt-1 text-sm break-all">https://your-worker.your-username.workers.dev/oauth/callback</code>
                </li>
                <li>å¯ç”¨ <a href="https://console.cloud.google.com/apis/library/gmail.googleapis.com" target="_blank" class="text-purple-400 hover:underline">Gmail API</a></li>
                <li>è®°å½• <code class="bg-purple-700/50 px-2 py-0.5 rounded text-purple-300">CLIENT_ID</code> å’Œ <code class="bg-purple-700/50 px-2 py-0.5 rounded text-purple-300">CLIENT_SECRET</code></li>
              </ol>
              <div class="mt-3 p-3 bg-yellow-900/30 border border-yellow-700/50 rounded-lg text-yellow-200 text-sm">
                âš ï¸ æ³¨æ„ï¼šå¦‚æœåº”ç”¨æœªå‘å¸ƒï¼Œéœ€åœ¨ OAuth åŒæ„å±å¹•æ·»åŠ æµ‹è¯•ç”¨æˆ·ï¼ˆä½ çš„ Gmail åœ°å€ï¼‰
              </div>
            </div>
          </div>
        </div>

        <!-- Step 3 -->
        <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
          <div class="flex gap-4">
            <div class="step-number bg-purple-600 rounded-full flex items-center justify-center font-bold shrink-0">3</div>
            <div class="flex-1">
              <h3 class="font-bold text-lg mb-2">åˆ›å»º Cloudflare Worker</h3>
              <ol class="list-decimal list-inside text-gray-300 space-y-1 ml-1">
                <li>ç™»å½• <a href="https://dash.cloudflare.com" target="_blank" class="text-purple-400 hover:underline">Cloudflare Dashboard</a></li>
                <li>è¿›å…¥ Workers & Pages â†’ Create application â†’ Create Worker</li>
                <li>ç»™ Worker èµ·åï¼ˆå¦‚ <code class="bg-gray-700 px-2 py-0.5 rounded">gmail-bot</code>ï¼‰</li>
                <li>ç‚¹å‡» Deploy åˆ›å»º</li>
              </ol>
            </div>
          </div>
        </div>

        <!-- Step 4 -->
        <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
          <div class="flex gap-4">
            <div class="step-number bg-purple-600 rounded-full flex items-center justify-center font-bold shrink-0">4</div>
            <div class="flex-1">
              <h3 class="font-bold text-lg mb-2">åˆ›å»º KV Namespace</h3>
              <ol class="list-decimal list-inside text-gray-300 space-y-1 ml-1">
                <li>Workers & Pages â†’ KV â†’ Create namespace</li>
                <li>åç§°å¡« <code class="bg-gray-700 px-2 py-0.5 rounded">USER_TOKENS</code></li>
                <li>è¿›å…¥ Worker Settings â†’ Variables â†’ KV Namespace Bindings</li>
                <li>Add bindingï¼šVariable name å¡« <code class="bg-gray-700 px-2 py-0.5 rounded">USER_TOKENS</code></li>
              </ol>
            </div>
          </div>
        </div>

        <!-- Step 5 -->
        <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
          <div class="flex gap-4">
            <div class="step-number bg-purple-600 rounded-full flex items-center justify-center font-bold shrink-0">5</div>
            <div class="flex-1">
              <h3 class="font-bold text-lg mb-2">è®¾ç½®ç¯å¢ƒå˜é‡</h3>
              <p class="text-gray-300 mb-3">åœ¨ Worker Settings â†’ Variables â†’ Environment Variables æ·»åŠ ï¼š</p>
              <div class="bg-gray-900 rounded-lg p-4 space-y-2 font-mono text-sm">
                <div><span class="text-purple-400">BOT_TOKEN</span> = <span class="text-gray-400">ä½ çš„ Telegram Bot Token</span></div>
                <div><span class="text-purple-400">BOT_SECRET</span> = <span class="text-gray-400">è‡ªå®šä¹‰å¯†ç ï¼ˆå¦‚ mysecret123ï¼‰</span></div>
                <div><span class="text-purple-400">GOOGLE_CLIENT_ID</span> = <span class="text-gray-400">OAuth Client ID</span></div>
                <div><span class="text-purple-400">GOOGLE_CLIENT_SECRET</span> = <span class="text-gray-400">OAuth Client Secret</span></div>
              </div>
              <div class="mt-3 p-3 bg-blue-900/30 border border-blue-700/50 rounded-lg text-blue-200 text-sm">
                ğŸ’¡ å»ºè®®å°† GOOGLE_CLIENT_SECRET è®¾ä¸ºåŠ å¯†å˜é‡ï¼ˆEncryptï¼‰
              </div>
            </div>
          </div>
        </div>

        <!-- Step 6 -->
        <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
          <div class="flex gap-4">
            <div class="step-number bg-purple-600 rounded-full flex items-center justify-center font-bold shrink-0">6</div>
            <div class="flex-1">
              <h3 class="font-bold text-lg mb-2">å¤åˆ¶ä»£ç åˆ° Worker</h3>
              <ol class="list-decimal list-inside text-gray-300 space-y-1 ml-1">
                <li>åœ¨ Worker é¡µé¢ç‚¹å‡» "Edit code" æˆ– "Quick edit"</li>
                <li>åˆ é™¤é»˜è®¤ä»£ç </li>
                <li>å¤åˆ¶ä¸‹æ–¹å®Œæ•´ä»£ç ç²˜è´´</li>
                <li>ç‚¹å‡» Save and Deploy</li>
              </ol>
            </div>
          </div>
        </div>

        <!-- Step 7 -->
        <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
          <div class="flex gap-4">
            <div class="step-number bg-purple-600 rounded-full flex items-center justify-center font-bold shrink-0">7</div>
            <div class="flex-1">
              <h3 class="font-bold text-lg mb-2">ä¸€é”®è®¾ç½® Webhook</h3>
              <p class="text-gray-300 mb-2">æµè§ˆå™¨è®¿é—®ä»¥ä¸‹åœ°å€å®Œæˆè®¾ç½®ï¼š</p>
              <code class="block bg-gray-700 px-3 py-2 rounded text-sm break-all">
                https://your-worker.workers.dev/setup?secret=ä½ çš„BOT_SECRET
              </code>
              <p class="text-gray-400 text-sm mt-2">çœ‹åˆ° "âœ… è®¾ç½®æˆåŠŸ" å³å®Œæˆ</p>
            </div>
          </div>
        </div>

        <!-- Step 8 -->
        <div class="bg-gray-800 rounded-xl p-6 border border-gray-700 border-green-500/50">
          <div class="flex gap-4">
            <div class="step-number bg-green-600 rounded-full flex items-center justify-center font-bold shrink-0">âœ“</div>
            <div class="flex-1">
              <h3 class="font-bold text-lg mb-2 text-green-400">å¼€å§‹ä½¿ç”¨ï¼</h3>
              <ol class="list-decimal list-inside text-gray-300 space-y-1 ml-1">
                <li>åœ¨ Telegram æ‰¾åˆ°ä½ çš„ Bot</li>
                <li>å‘é€ <code class="bg-gray-700 px-2 py-0.5 rounded">/start</code> æŸ¥çœ‹èœå•</li>
                <li>å‘é€ <code class="bg-gray-700 px-2 py-0.5 rounded">/login</code> ç™»å½• Gmail</li>
                <li>å‘é€ <code class="bg-gray-700 px-2 py-0.5 rounded">/new</code> æŸ¥çœ‹æœªè¯»é‚®ä»¶</li>
              </ol>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Complete Code -->
    <section class="mb-16">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-bold flex items-center gap-2">
          <span class="text-purple-400">ğŸ“„</span> å®Œæ•´ Worker ä»£ç 
        </h2>
        <button id="copyBtn" class="copy-btn bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-lg font-semibold transition flex items-center gap-2">
          <span id="copyIcon">ğŸ“‹</span>
          <span id="copyText">å¤åˆ¶ä»£ç </span>
        </button>
      </div>
      
      <div class="bg-gray-800 rounded-xl border border-gray-700 overflow-hidden">
        <div class="bg-gray-700/50 px-4 py-2 flex items-center gap-2 border-b border-gray-700">
          <span class="w-3 h-3 rounded-full bg-red-500"></span>
          <span class="w-3 h-3 rounded-full bg-yellow-500"></span>
          <span class="w-3 h-3 rounded-full bg-green-500"></span>
          <span class="ml-2 text-gray-400 text-sm font-mono">worker.js</span>
        </div>
        <div class="code-container">
          <pre><code class="language-javascript" id="workerCode"></code></pre>
        </div>
      </div>
    </section>

    <!-- Environment Variables -->
    <section class="mb-16">
      <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
        <span class="text-purple-400">âš™ï¸</span> ç¯å¢ƒå˜é‡è¯´æ˜
      </h2>
      <div class="bg-gray-800 rounded-xl border border-gray-700 overflow-hidden">
        <table class="w-full">
          <thead class="bg-gray-700/50">
            <tr>
              <th class="text-left px-5 py-3 font-semibold">å˜é‡å</th>
              <th class="text-left px-5 py-3 font-semibold">è¯´æ˜</th>
              <th class="text-left px-5 py-3 font-semibold">ç¤ºä¾‹</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-700">
            <tr>
              <td class="px-5 py-3 font-mono text-purple-400">BOT_TOKEN</td>
              <td class="px-5 py-3 text-gray-300">Telegram Bot Token</td>
              <td class="px-5 py-3 text-gray-400 text-sm">123456:ABC-DEF...</td>
            </tr>
            <tr>
              <td class="px-5 py-3 font-mono text-purple-400">BOT_SECRET</td>
              <td class="px-5 py-3 text-gray-300">Webhook ä¿æŠ¤å¯†ç </td>
              <td class="px-5 py-3 text-gray-400 text-sm">mysecret123</td>
            </tr>
            <tr>
              <td class="px-5 py-3 font-mono text-purple-400">GOOGLE_CLIENT_ID</td>
              <td class="px-5 py-3 text-gray-300">Google OAuth Client ID</td>
              <td class="px-5 py-3 text-gray-400 text-sm">xxx.apps.googleusercontent.com</td>
            </tr>
            <tr>
              <td class="px-5 py-3 font-mono text-purple-400">GOOGLE_CLIENT_SECRET</td>
              <td class="px-5 py-3 text-gray-300">Google OAuth Secret (å»ºè®®åŠ å¯†)</td>
              <td class="px-5 py-3 text-gray-400 text-sm">GOCSPX-xxx</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- Troubleshooting -->
    <section class="mb-16">
      <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
        <span class="text-purple-400">ğŸ”§</span> å¸¸è§é—®é¢˜
      </h2>
      <div class="space-y-4">
        <details class="bg-gray-800 rounded-xl border border-gray-700">
          <summary class="px-5 py-4 cursor-pointer font-semibold">æˆæƒæ—¶æç¤º "Access blocked" æˆ– "æœªç»éªŒè¯çš„åº”ç”¨"</summary>
          <div class="px-5 pb-4 text-gray-300">
            <p>è¿™æ˜¯å› ä¸º Google åº”ç”¨æœªå‘å¸ƒã€‚è§£å†³æ–¹æ³•ï¼š</p>
            <ol class="list-decimal list-inside mt-2 space-y-1">
              <li>è¿›å…¥ Google Cloud Console â†’ OAuth åŒæ„å±å¹•</li>
              <li>åœ¨"æµ‹è¯•ç”¨æˆ·"ä¸­æ·»åŠ ä½ çš„ Gmail åœ°å€</li>
              <li>æˆ–è€…å‘å¸ƒåº”ç”¨ï¼ˆéœ€è¦éªŒè¯ï¼‰</li>
            </ol>
          </div>
        </details>
        
        <details class="bg-gray-800 rounded-xl border border-gray-700">
          <summary class="px-5 py-4 cursor-pointer font-semibold">æç¤º "redirect_uri_mismatch"</summary>
          <div class="px-5 pb-4 text-gray-300">
            <p>é‡å®šå‘ URI ä¸åŒ¹é…ã€‚ç¡®ä¿ Google Console ä¸­çš„æˆæƒé‡å®šå‘ URI å®Œå…¨åŒ¹é…ï¼š</p>
            <code class="block bg-gray-700 px-3 py-2 rounded mt-2 text-sm">https://your-worker.workers.dev/oauth/callback</code>
          </div>
        </details>
        
        <details class="bg-gray-800 rounded-xl border border-gray-700">
          <summary class="px-5 py-4 cursor-pointer font-semibold">Bot æ²¡æœ‰å“åº”</summary>
          <div class="px-5 pb-4 text-gray-300">
            <ol class="list-decimal list-inside space-y-1">
              <li>ç¡®è®¤å·²è®¿é—® <code class="bg-gray-700 px-2 py-0.5 rounded">/setup?secret=xxx</code> è®¾ç½® Webhook</li>
              <li>æ£€æŸ¥ Worker æ—¥å¿—æ˜¯å¦æœ‰é”™è¯¯</li>
              <li>ç¡®è®¤ç¯å¢ƒå˜é‡é…ç½®æ­£ç¡®</li>
              <li>ç¡®è®¤ KV Namespace å·²ç»‘å®š</li>
            </ol>
          </div>
        </details>
        
        <details class="bg-gray-800 rounded-xl border border-gray-700">
          <summary class="px-5 py-4 cursor-pointer font-semibold">åœ¨ä¸­å›½å¤§é™†æ— æ³•æˆæƒ</summary>
          <div class="px-5 pb-4 text-gray-300">
            <p>é¦–æ¬¡æˆæƒéœ€è¦è®¿é—® Googleï¼Œå¯èƒ½éœ€è¦ç§‘å­¦ä¸Šç½‘ã€‚æˆæƒæˆåŠŸåï¼ŒBot è°ƒç”¨ Gmail API æ˜¯é€šè¿‡ Cloudflare Workers å‘èµ·çš„ï¼Œä¸å—æœ¬åœ°ç½‘ç»œé™åˆ¶ã€‚</p>
          </div>
        </details>

        <details class="bg-gray-800 rounded-xl border border-gray-700">
          <summary class="px-5 py-4 cursor-pointer font-semibold">Token åˆ·æ–°å¤±è´¥</summary>
          <div class="px-5 pb-4 text-gray-300">
            <p>å¯èƒ½åŸå› ï¼š</p>
            <ol class="list-decimal list-inside mt-2 space-y-1">
              <li>ç”¨æˆ·æ’¤é”€äº†æˆæƒ â†’ éœ€è¦é‡æ–° /login</li>
              <li>Refresh Token è¿‡æœŸï¼ˆ6ä¸ªæœˆæœªä½¿ç”¨ï¼‰â†’ é‡æ–°ç™»å½•</li>
              <li>OAuth å‡­è¯è¢«åˆ é™¤æˆ–æ›´æ”¹ â†’ æ£€æŸ¥ Google Console</li>
            </ol>
          </div>
        </details>
      </div>
    </section>

    <!-- Architecture -->
    <section class="mb-16">
      <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
        <span class="text-purple-400">ğŸ—ï¸</span> æ¶æ„è¯´æ˜
      </h2>
      <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
        <div class="flex flex-wrap gap-4 justify-center items-center text-center">
          <div class="bg-blue-600/20 border border-blue-500/50 rounded-lg px-4 py-3">
            <div class="text-2xl mb-1">ğŸ“±</div>
            <div class="text-sm">Telegram</div>
          </div>
          <div class="text-gray-500">â†’</div>
          <div class="bg-orange-600/20 border border-orange-500/50 rounded-lg px-4 py-3">
            <div class="text-2xl mb-1">âš¡</div>
            <div class="text-sm">Cloudflare Worker</div>
          </div>
          <div class="text-gray-500">â†’</div>
          <div class="bg-red-600/20 border border-red-500/50 rounded-lg px-4 py-3">
            <div class="text-2xl mb-1">ğŸ“§</div>
            <div class="text-sm">Gmail API</div>
          </div>
        </div>
        <div class="mt-6 text-center text-gray-400 text-sm">
          <p>Cloudflare KV å­˜å‚¨ç”¨æˆ· Token å’Œåˆ†é¡µçŠ¶æ€ï¼ŒWorker å¤„ç† Webhook å¹¶è°ƒç”¨ Gmail API</p>
        </div>
      </div>
    </section>
  </main>

  <!-- Footer -->
  <footer class="bg-gray-800/50 border-t border-gray-700 py-8 px-4">
    <div class="max-w-5xl mx-auto text-center text-gray-400">
      <p>Gmail Telegram Bot - åŸºäº Cloudflare Workers</p>
      <p class="mt-2 text-sm">å®Œå…¨å…è´¹ Â· å®‰å…¨å¯é  Â· åˆ†é¡µæµè§ˆ</p>
    </div>
  </footer>

  <script>
    // Worker ä»£ç  - å®Œæ•´ç‰ˆæœ¬ï¼ˆæ”¯æŒåˆ†é¡µï¼‰
    const workerCode = `/**
 * Gmail Telegram Bot - Cloudflare Worker
 * åŠŸèƒ½ï¼šé€šè¿‡ Telegram Bot å®‰å…¨è®¿é—® Gmail é‚®ç®±
 * ç‰ˆæœ¬ï¼š3.0ï¼ˆæ”¯æŒåˆ†é¡µæµè§ˆï¼‰
 */

// ==================== é…ç½®å¸¸é‡ ====================
const GMAIL_SCOPES = [
  'https://www.googleapis.com/auth/gmail.readonly',
  'https://www.googleapis.com/auth/gmail.modify'
].join(' ');

const PAGE_SIZE = 5;  // æ¯é¡µæ˜¾ç¤ºé‚®ä»¶æ•°
const MAX_CONTENT_LENGTH = 3500;
const TOKEN_REFRESH_BUFFER = 60000;
const MAX_ATTACHMENT_SIZE = 15 * 1024 * 1024;

// ==================== ä¸»å…¥å£ ====================
export default {
  async fetch(request, env, ctx) {
    const url = new URL(request.url);
    const path = url.pathname;

    try {
      if (path === '/setup') {
        return await handleSetup(url, env);
      }
      
      if (path === '/oauth/callback') {
        return await handleOAuthCallback(request, env);
      }
      
      if (path === '/webhook' && request.method === 'POST') {
        const secret = url.searchParams.get('secret');
        if (secret !== env.BOT_SECRET) {
          return jsonResponse({ error: 'Unauthorized' }, 401);
        }
        const update = await request.json();
        ctx.waitUntil(handleBotUpdate(update, env, url.origin));
        return jsonResponse({ ok: true });
      }

      return new Response(generateHomePage(), {
        headers: { 'Content-Type': 'text/html; charset=utf-8' }
      });
    } catch (error) {
      console.error('Error:', error);
      return jsonResponse({ error: error.message }, 500);
    }
  }
};

// ==================== Webhook è®¾ç½® ====================
async function handleSetup(url, env) {
  const secret = url.searchParams.get('secret');
  if (secret !== env.BOT_SECRET) {
    return new Response('âŒ é”™è¯¯ï¼šè¯·æä¾›æ­£ç¡®çš„ secret å‚æ•°', { 
      status: 401,
      headers: { 'Content-Type': 'text/plain; charset=utf-8' }
    });
  }

  const webhookUrl = \`\${url.origin}/webhook?secret=\${env.BOT_SECRET}\`;
  const results = [];

  const webhookResp = await telegramAPI(env.BOT_TOKEN, 'setWebhook', { 
    url: webhookUrl,
    allowed_updates: ['message', 'callback_query']
  });
  results.push(\`Webhook: \${webhookResp.ok ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥'}\`);

  const commands = [
    { command: 'start', description: 'ğŸ  å¼€å§‹ä½¿ç”¨' },
    { command: 'login', description: 'ğŸ” ç™»å½• Gmail' },
    { command: 'new', description: 'ğŸ“¬ æŸ¥çœ‹æœªè¯»é‚®ä»¶' },
    { command: 'today', description: 'ğŸ“… ä»Šæ—¥é‚®ä»¶' },
    { command: 'stats', description: 'ğŸ“Š é‚®ç®±ç»Ÿè®¡' },
    { command: 'search', description: 'ğŸ” æœç´¢é‚®ä»¶' },
    { command: 'logout', description: 'ğŸšª é€€å‡ºç™»å½•' },
    { command: 'help', description: 'â“ å¸®åŠ©ä¿¡æ¯' }
  ];
  
  const commandsResp = await telegramAPI(env.BOT_TOKEN, 'setMyCommands', { commands });
  results.push(\`å‘½ä»¤èœå•: \${commandsResp.ok ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥'}\`);

  const meResp = await telegramAPI(env.BOT_TOKEN, 'getMe');
  if (meResp.ok) {
    results.push(\`\\nBot: @\${meResp.result.username}\`);
  }

  return new Response(\`ğŸ¤– Gmail Bot è®¾ç½®ç»“æœ\\n\${'='.repeat(30)}\\n\${results.join('\\n')}\\n\\nç°åœ¨å¯ä»¥åœ¨ Telegram ä¸­ä½¿ç”¨ Bot äº†ï¼\`, {
    headers: { 'Content-Type': 'text/plain; charset=utf-8' }
  });
}

// ==================== OAuth å›è°ƒå¤„ç† ====================
async function handleOAuthCallback(request, env) {
  const url = new URL(request.url);
  const code = url.searchParams.get('code');
  const state = url.searchParams.get('state');
  const error = url.searchParams.get('error');

  if (error) {
    return new Response(generateResultPage(false, error), {
      headers: { 'Content-Type': 'text/html; charset=utf-8' }
    });
  }

  if (!code || !state) {
    return new Response(generateResultPage(false, 'ç¼ºå°‘å¿…è¦å‚æ•°'), {
      headers: { 'Content-Type': 'text/html; charset=utf-8' }
    });
  }

  let stateData;
  try {
    stateData = JSON.parse(atob(state));
  } catch {
    return new Response(generateResultPage(false, 'State æ— æ•ˆ'), {
      headers: { 'Content-Type': 'text/html; charset=utf-8' }
    });
  }

  const { userId, nonce } = stateData;
  
  const storedNonce = await env.USER_TOKENS.get(\`nonce:\${userId}\`);
  if (!storedNonce || storedNonce !== nonce) {
    return new Response(generateResultPage(false, 'æˆæƒå·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•'), {
      headers: { 'Content-Type': 'text/html; charset=utf-8' }
    });
  }

  const tokenResp = await fetch('https://oauth2.googleapis.com/token', {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: new URLSearchParams({
      code,
      client_id: env.GOOGLE_CLIENT_ID,
      client_secret: env.GOOGLE_CLIENT_SECRET,
      redirect_uri: \`\${url.origin}/oauth/callback\`,
      grant_type: 'authorization_code'
    })
  });

  const tokenData = await tokenResp.json();

  if (!tokenData.access_token) {
    return new Response(generateResultPage(false, tokenData.error_description || 'Token è·å–å¤±è´¥'), {
      headers: { 'Content-Type': 'text/html; charset=utf-8' }
    });
  }

  const profileResp = await fetch('https://gmail.googleapis.com/gmail/v1/users/me/profile', {
    headers: { Authorization: \`Bearer \${tokenData.access_token}\` }
  });
  const profile = await profileResp.json();

  await env.USER_TOKENS.put(\`token:\${userId}\`, JSON.stringify({
    access_token: tokenData.access_token,
    refresh_token: tokenData.refresh_token,
    expiry: Date.now() + (tokenData.expires_in * 1000),
    email: profile.emailAddress || 'unknown'
  }));

  await env.USER_TOKENS.delete(\`nonce:\${userId}\`);

  await telegramAPI(env.BOT_TOKEN, 'sendMessage', {
    chat_id: userId,
    text: \`âœ… *ç™»å½•æˆåŠŸï¼*\\n\\nğŸ“§ å·²ç»‘å®š: \\\`\${profile.emailAddress || 'Gmail'}\\\`\\n\\nå‘é€ /new æŸ¥çœ‹æœªè¯»é‚®ä»¶\`,
    parse_mode: 'Markdown'
  });

  return new Response(generateResultPage(true, profile.emailAddress), {
    headers: { 'Content-Type': 'text/html; charset=utf-8' }
  });
}

// ç”Ÿæˆç»“æœé¡µé¢
function generateResultPage(success, message) {
  const bgColor = success ? '#10b981' : '#ef4444';
  const icon = success ? 'âœ“' : 'âœ•';
  const title = success ? 'æˆæƒæˆåŠŸï¼' : 'æˆæƒå¤±è´¥';
  
  return \`<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>\${title} - Gmail Bot</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      color: #fff;
      padding: 20px;
    }
    .card {
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
      border-radius: 24px;
      padding: 48px;
      text-align: center;
      max-width: 420px;
      width: 100%;
      border: 1px solid rgba(255,255,255,0.2);
      box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
    }
    .icon {
      width: 80px;
      height: 80px;
      background: \${bgColor};
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 24px;
      font-size: 40px;
      font-weight: bold;
    }
    h1 { font-size: 28px; margin-bottom: 16px; color: \${success ? '#34d399' : '#f87171'}; }
    .message {
      background: rgba(255,255,255,0.1);
      padding: 12px 20px;
      border-radius: 12px;
      margin: 20px 0;
      font-size: 15px;
      color: #a5b4fc;
    }
    .hint { color: #94a3b8; font-size: 14px; margin-bottom: 24px; }
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 14px 32px;
      background: #0088cc;
      color: white;
      text-decoration: none;
      border-radius: 12px;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div class="card">
    <div class="icon">\${icon}</div>
    <h1>\${title}</h1>
    <div class="message">\${success ? 'ğŸ“§ ' + message : message}</div>
    <p class="hint">\${success ? 'ç°åœ¨å¯ä»¥è¿”å› Telegram ä½¿ç”¨ /new æŸ¥çœ‹é‚®ä»¶' : 'è¯·è¿”å› Telegram é‡è¯•'}</p>
    <a href="https://t.me" class="btn">æ‰“å¼€ Telegram</a>
  </div>
</body>
</html>\`;
}

// ==================== Bot æ›´æ–°å¤„ç† ====================
async function handleBotUpdate(update, env, origin) {
  if (update.callback_query) {
    await handleCallbackQuery(update.callback_query, env, origin);
    return;
  }

  if (!update.message?.text) return;

  const msg = update.message;
  const chatId = msg.chat.id;
  const userId = msg.from.id.toString();
  const text = msg.text.trim();

  const [command, ...args] = text.split(/\\s+/);
  const cmd = command.toLowerCase().replace(/^\\//, '').replace(/@.*$/, '');

  switch (cmd) {
    case 'start':
    case 'help':
      await sendWelcome(chatId, env);
      break;
    case 'login':
      await sendLoginLink(chatId, userId, origin, env);
      break;
    case 'logout':
      await handleLogout(chatId, userId, env);
      break;
    case 'new':
    case 'unread':
      await handleMailList(chatId, userId, 'is:unread', null, null, env);
      break;
    case 'today':
      const today = new Date().toISOString().split('T')[0].replace(/-/g, '/');
      await handleMailList(chatId, userId, \`after:\${today}\`, null, null, env);
      break;
    case 'stats':
      await handleStats(chatId, userId, env);
      break;
    case 'search':
      const query = args.join(' ');
      if (!query) {
        await sendSearchHelp(chatId, env);
      } else {
        await handleMailList(chatId, userId, query, null, null, env);
      }
      break;
  }
}

// ==================== å‘½ä»¤å¤„ç†å‡½æ•° ====================
async function sendWelcome(chatId, env) {
  const keyboard = {
    inline_keyboard: [
      [
        { text: 'ğŸ” ç™»å½• Gmail', callback_data: 'action:login' },
        { text: 'ğŸ“¬ æœªè¯»é‚®ä»¶', callback_data: 'action:new' }
      ],
      [
        { text: 'ğŸ“… ä»Šæ—¥é‚®ä»¶', callback_data: 'action:today' },
        { text: 'ğŸ“Š é‚®ç®±ç»Ÿè®¡', callback_data: 'action:stats' }
      ],
      [
        { text: 'ğŸ” æœç´¢å¸®åŠ©', callback_data: 'action:search_help' },
        { text: 'ğŸšª é€€å‡ºç™»å½•', callback_data: 'action:logout' }
      ]
    ]
  };

  const text = \`ğŸ¤– *Gmail Bot*

æ¬¢è¿ä½¿ç”¨ Gmail é‚®ä»¶åŠ©æ‰‹ï¼

*å¯ç”¨å‘½ä»¤ï¼š*
/new - æŸ¥çœ‹æœªè¯»é‚®ä»¶ï¼ˆåˆ†é¡µæµè§ˆï¼‰
/today - ä»Šæ—¥æ”¶åˆ°çš„é‚®ä»¶
/stats - é‚®ç®±ç»Ÿè®¡ä¿¡æ¯
/search å…³é”®è¯ - æœç´¢é‚®ä»¶
/login - ç™»å½• Gmail
/logout - é€€å‡ºç™»å½•

ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¿«é€Ÿæ“ä½œ ğŸ‘‡\`;

  await telegramAPI(env.BOT_TOKEN, 'sendMessage', {
    chat_id: chatId,
    text,
    parse_mode: 'Markdown',
    reply_markup: keyboard
  });
}

async function sendLoginLink(chatId, userId, origin, env) {
  await env.USER_TOKENS.put('worker_origin', origin);
  
  const nonce = crypto.randomUUID();
  await env.USER_TOKENS.put(\`nonce:\${userId}\`, nonce, { expirationTtl: 600 });

  const state = btoa(JSON.stringify({ userId, nonce }));
  
  const authUrl = new URL('https://accounts.google.com/o/oauth2/v2/auth');
  authUrl.searchParams.set('client_id', env.GOOGLE_CLIENT_ID);
  authUrl.searchParams.set('redirect_uri', \`\${origin}/oauth/callback\`);
  authUrl.searchParams.set('response_type', 'code');
  authUrl.searchParams.set('scope', GMAIL_SCOPES);
  authUrl.searchParams.set('access_type', 'offline');
  authUrl.searchParams.set('prompt', 'consent');
  authUrl.searchParams.set('state', state);

  const keyboard = {
    inline_keyboard: [[
      { text: 'ğŸ” ç‚¹å‡»ç™»å½• Gmail', url: authUrl.toString() }
    ]]
  };

  await telegramAPI(env.BOT_TOKEN, 'sendMessage', {
    chat_id: chatId,
    text: 'è¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ç™»å½• Gmail\\n\\nğŸ”’ ä½¿ç”¨ Google å®˜æ–¹æˆæƒï¼Œå®‰å…¨å¯é ',
    reply_markup: keyboard
  });
}

async function handleLogout(chatId, userId, env) {
  await env.USER_TOKENS.delete(\`token:\${userId}\`);
  await sendMessage(chatId, 'âœ… å·²é€€å‡ºç™»å½•\\n\\nä½¿ç”¨ /login é‡æ–°ç™»å½•', env);
}

async function sendSearchHelp(chatId, env) {
  const keyboard = {
    inline_keyboard: [
      [
        { text: 'ğŸ“¬ æœªè¯»é‚®ä»¶', callback_data: 'search:is:unread' },
        { text: 'â­ æ˜Ÿæ ‡é‚®ä»¶', callback_data: 'search:is:starred' }
      ],
      [
        { text: 'ğŸ“ æœ‰é™„ä»¶', callback_data: 'search:has:attachment' },
        { text: 'ğŸ“† æœ¬å‘¨é‚®ä»¶', callback_data: 'search:newer_than:7d' }
      ]
    ]
  };

  await telegramAPI(env.BOT_TOKEN, 'sendMessage', {
    chat_id: chatId,
    text: \`ğŸ” *æœç´¢å¸®åŠ©*\\n\\n*ç”¨æ³•ï¼š* /search å…³é”®è¯\\n\\n*ç¤ºä¾‹ï¼š*\\nâ€¢ \\\`/search ä¼šè®®\\\` - æœç´¢å†…å®¹\\nâ€¢ \\\`/search from:test@qq.com\\\` - æŒ‰å‘ä»¶äºº\\nâ€¢ \\\`/search subject:æŠ¥å‘Š\\\` - æŒ‰ä¸»é¢˜\\nâ€¢ \\\`/search after:2024/01/01\\\` - æŒ‰æ—¥æœŸ\\n\\næˆ–ç‚¹å‡»å¿«æ·æŒ‰é’®ï¼š\`,
    parse_mode: 'Markdown',
    reply_markup: keyboard
  });
}

// ==================== é‚®ä»¶åˆ—è¡¨ï¼ˆåˆ†é¡µï¼‰ ====================
async function handleMailList(chatId, userId, query, pageToken, editMsgId, env) {
  const tokenData = await getValidToken(userId, env);
  if (!tokenData) {
    await sendMessage(chatId, 'âš ï¸ è¯·å…ˆ /login ç™»å½•', env);
    return;
  }

  // æ˜¾ç¤ºåŠ è½½ä¸­ï¼ˆä»…æ–°æ¶ˆæ¯æ—¶ï¼‰
  let loadingMsgId = null;
  if (!editMsgId) {
    const loadingMsg = await telegramAPI(env.BOT_TOKEN, 'sendMessage', {
      chat_id: chatId,
      text: 'ğŸ” æ­£åœ¨æŸ¥è¯¢...'
    });
    loadingMsgId = loadingMsg.result?.message_id;
  }

  try {
    // è·å–é‚®ä»¶åˆ—è¡¨
    const listUrl = new URL('https://gmail.googleapis.com/gmail/v1/users/me/messages');
    listUrl.searchParams.set('q', query);
    listUrl.searchParams.set('maxResults', PAGE_SIZE.toString());
    if (pageToken) {
      listUrl.searchParams.set('pageToken', pageToken);
    }

    const listResp = await fetch(listUrl, {
      headers: { Authorization: \`Bearer \${tokenData.access_token}\` }
    });

    if (!listResp.ok) throw new Error('API è¯·æ±‚å¤±è´¥');

    const listData = await listResp.json();
    const messages = listData.messages || [];
    const nextPageToken = listData.nextPageToken;

    // åˆ é™¤åŠ è½½æ¶ˆæ¯
    if (loadingMsgId) {
      await telegramAPI(env.BOT_TOKEN, 'deleteMessage', {
        chat_id: chatId,
        message_id: loadingMsgId
      }).catch(() => {});
    }

    if (messages.length === 0) {
      const text = \`ğŸ“­ æ²¡æœ‰æ‰¾åˆ°é‚®ä»¶\\n\\næœç´¢: \\\`\${query}\\\`\`;
      if (editMsgId) {
        await telegramAPI(env.BOT_TOKEN, 'editMessageText', {
          chat_id: chatId,
          message_id: editMsgId,
          text,
          parse_mode: 'Markdown'
        });
      } else {
        await sendMessage(chatId, text, env, 'Markdown');
      }
      return;
    }

    // è·å–é‚®ä»¶æ‘˜è¦
    const summaries = [];
    for (const msg of messages) {
      const detail = await fetch(
        \`https://gmail.googleapis.com/gmail/v1/users/me/messages/\${msg.id}?format=metadata&metadataHeaders=From&metadataHeaders=Subject&metadataHeaders=Date\`,
        { headers: { Authorization: \`Bearer \${tokenData.access_token}\` } }
      );
      if (detail.ok) {
        const mail = await detail.json();
        const headers = mail.payload?.headers || [];
        const getHeader = (n) => headers.find(h => h.name.toLowerCase() === n.toLowerCase())?.value || '';
        
        let from = getHeader('From');
        const emailMatch = from.match(/[\\w.-]+@[\\w.-]+\\.\\w+/);
        if (emailMatch) {
          from = from.replace(/[<>]/g, '').replace(emailMatch[0], '').replace(/"/g, '').trim() || emailMatch[0];
        }
        
        let dateStr = '';
        try {
          const d = new Date(getHeader('Date'));
          dateStr = \`\${d.getMonth()+1}/\${d.getDate()} \${d.getHours()}:\${String(d.getMinutes()).padStart(2,'0')}\`;
        } catch {}
        
        summaries.push({
          id: msg.id,
          from: from.substring(0, 18) + (from.length > 18 ? '..' : ''),
          subject: (getHeader('Subject') || '(æ— ä¸»é¢˜)').substring(0, 25) + ((getHeader('Subject') || '').length > 25 ? '..' : ''),
          date: dateStr,
          isUnread: mail.labelIds?.includes('UNREAD')
        });
      }
    }

    // æ„å»ºæ¶ˆæ¯æ–‡æœ¬
    let text = \`ğŸ“¬ *é‚®ä»¶åˆ—è¡¨*  |  \${query}\\n\${'â”€'.repeat(28)}\\n\\n\`;
    
    summaries.forEach((m, i) => {
      text += \`\${m.isUnread ? 'ğŸ”µ' : 'âšªï¸'} *\${i+1}.* \${m.subject}\\n\`;
      text += \`    _\${m.from}_ Â· \${m.date}\\n\\n\`;
    });

    // æ„å»ºæŒ‰é’®
    const buttons = [];
    
    // é‚®ä»¶æŒ‰é’®ï¼ˆæ¯è¡Œ2ä¸ªï¼‰
    for (let i = 0; i < summaries.length; i += 2) {
      const row = [];
      row.push({ text: \`\${summaries[i].isUnread ? 'ğŸ”µ' : 'ğŸ“§'} \${i+1}. æŸ¥çœ‹\`, callback_data: \`mail:\${summaries[i].id}\` });
      if (summaries[i+1]) {
        row.push({ text: \`\${summaries[i+1].isUnread ? 'ğŸ”µ' : 'ğŸ“§'} \${i+2}. æŸ¥çœ‹\`, callback_data: \`mail:\${summaries[i+1].id}\` });
      }
      buttons.push(row);
    }

    // åˆ†é¡µæŒ‰é’®
    const navRow = [];
    if (pageToken) {
      // å­˜å‚¨å½“å‰é¡µä¿¡æ¯ä»¥ä¾¿è¿”å›
      navRow.push({ text: 'ğŸ  é¦–é¡µ', callback_data: \`list:\${query.substring(0,30)}\` });
    }
    if (nextPageToken) {
      // å­˜å‚¨ä¸‹ä¸€é¡µ token
      const pageId = Date.now().toString(36);
      await env.USER_TOKENS.put(\`page:\${userId}:\${pageId}\`, JSON.stringify({ query, token: nextPageToken }), { expirationTtl: 3600 });
      navRow.push({ text: 'â¡ï¸ ä¸‹ä¸€é¡µ', callback_data: \`page:\${pageId}\` });
    }
    if (navRow.length > 0) buttons.push(navRow);

    // åˆ·æ–°æŒ‰é’®
    buttons.push([
      { text: 'ğŸ”„ åˆ·æ–°', callback_data: \`list:\${query.substring(0,30)}\` },
      { text: 'ğŸ  èœå•', callback_data: 'action:menu' }
    ]);

    const keyboard = { inline_keyboard: buttons };

    if (editMsgId) {
      await telegramAPI(env.BOT_TOKEN, 'editMessageText', {
        chat_id: chatId,
        message_id: editMsgId,
        text,
        parse_mode: 'Markdown',
        reply_markup: keyboard
      });
    } else {
      await telegramAPI(env.BOT_TOKEN, 'sendMessage', {
        chat_id: chatId,
        text,
        parse_mode: 'Markdown',
        reply_markup: keyboard
      });
    }
  } catch (error) {
    console.error('Mail list error:', error);
    if (loadingMsgId) {
      await telegramAPI(env.BOT_TOKEN, 'deleteMessage', { chat_id: chatId, message_id: loadingMsgId }).catch(() => {});
    }
    await sendMessage(chatId, \`âŒ æŸ¥è¯¢å¤±è´¥: \${error.message}\`, env);
  }
}

// ==================== é‚®ä»¶è¯¦æƒ… ====================
async function sendMailDetail(chatId, mailId, accessToken, env, editMsgId = null) {
  const detailResp = await fetch(
    \`https://gmail.googleapis.com/gmail/v1/users/me/messages/\${mailId}?format=full\`,
    { headers: { Authorization: \`Bearer \${accessToken}\` } }
  );
  
  if (!detailResp.ok) return;

  const mail = await detailResp.json();
  const headers = mail.payload?.headers || [];
  const getHeader = (n) => headers.find(h => h.name.toLowerCase() === n.toLowerCase())?.value || '';
  
  const from = getHeader('From');
  const subject = getHeader('Subject') || '(æ— ä¸»é¢˜)';
  const date = getHeader('Date');
  const isUnread = mail.labelIds?.includes('UNREAD');

  // è§£æå‘ä»¶äºº
  let fromName = from, fromEmail = from;
  const emailMatch = from.match(/[\\w.-]+@[\\w.-]+\\.\\w+/);
  if (emailMatch) {
    fromEmail = emailMatch[0];
    fromName = from.replace(/[<>]/g, '').replace(emailMatch[0], '').replace(/"/g, '').trim() || fromEmail;
  }

  // æ ¼å¼åŒ–æ—¶é—´
  let dateStr = date;
  try {
    const d = new Date(date);
    dateStr = d.toLocaleString('zh-CN', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
  } catch {}

  // æå–æ­£æ–‡
  const content = extractEmailContent(mail.payload);
  
  // æ£€æµ‹é™„ä»¶
  const attachments = detectAttachments(mail.payload);

  // æ„å»ºæ¶ˆæ¯
  let text = \`\${isUnread ? 'ğŸ”µ æœªè¯»' : 'âšªï¸ å·²è¯»'} | \${subject}\\n\`;
  text += \`\${'â”€'.repeat(28)}\\n\`;
  text += \`ğŸ‘¤ \${fromName}\\n\`;
  if (fromName !== fromEmail) text += \`ğŸ“§ \${fromEmail}\\n\`;
  text += \`ğŸ• \${dateStr}\\n\`;
  if (attachments.length > 0) {
    text += \`ğŸ“ é™„ä»¶(\${attachments.length}): \${attachments.map(a => a.name).join(', ')}\\n\`;
  }
  text += \`\${'â”€'.repeat(28)}\\n\\n\`;
  text += content;

  // æ„å»ºæŒ‰é’®
  const buttons = [];
  
  // æ“ä½œæŒ‰é’®
  const actionRow = [];
  if (isUnread) actionRow.push({ text: 'âœ… æ ‡è®°å·²è¯»', callback_data: \`read:\${mailId}\` });
  else actionRow.push({ text: 'ğŸ“© æ ‡è®°æœªè¯»', callback_data: \`unread:\${mailId}\` });
  actionRow.push({ text: 'â­ æ˜Ÿæ ‡', callback_data: \`star:\${mailId}\` });
  actionRow.push({ text: 'ğŸ—‘ï¸ åˆ é™¤', callback_data: \`delete:\${mailId}\` });
  buttons.push(actionRow);

  // å‘ä»¶äººæœç´¢
  if (fromEmail) {
    buttons.push([{ text: \`ğŸ” æœç´¢ \${fromName.substring(0,12)} çš„é‚®ä»¶\`, callback_data: \`search:from:\${fromEmail.substring(0,30)}\` }]);
  }

  // é™„ä»¶æŒ‰é’®
  if (attachments.length > 0) {
    const attRow = attachments.slice(0, 3).map((a, i) => ({
      text: \`ğŸ“ \${a.name.substring(0,10)}\`,
      callback_data: \`attach:\${mailId}:\${i}\`
    }));
    buttons.push(attRow);
  }

  // è¿”å›åˆ—è¡¨
  buttons.push([{ text: 'â¬…ï¸ è¿”å›åˆ—è¡¨', callback_data: 'action:back' }]);

  const keyboard = { inline_keyboard: buttons };

  if (editMsgId) {
    await telegramAPI(env.BOT_TOKEN, 'editMessageText', {
      chat_id: chatId,
      message_id: editMsgId,
      text,
      reply_markup: keyboard
    });
  } else {
    await telegramAPI(env.BOT_TOKEN, 'sendMessage', {
      chat_id: chatId,
      text,
      reply_markup: keyboard
    });
  }
}

// ==================== é‚®ç®±ç»Ÿè®¡ ====================
async function handleStats(chatId, userId, env) {
  const tokenData = await getValidToken(userId, env);
  if (!tokenData) {
    await sendMessage(chatId, 'âš ï¸ è¯·å…ˆ /login ç™»å½•', env);
    return;
  }

  const loadingMsg = await telegramAPI(env.BOT_TOKEN, 'sendMessage', {
    chat_id: chatId,
    text: 'ğŸ“Š æ­£åœ¨è·å–ç»Ÿè®¡...'
  });

  try {
    const token = tokenData.access_token;
    
    const [profile, unread, today, starred] = await Promise.all([
      fetch('https://gmail.googleapis.com/gmail/v1/users/me/profile', { headers: { Authorization: \`Bearer \${token}\` } }).then(r => r.json()),
      fetch('https://gmail.googleapis.com/gmail/v1/users/me/messages?q=is:unread&maxResults=1', { headers: { Authorization: \`Bearer \${token}\` } }).then(r => r.json()),
      fetch(\`https://gmail.googleapis.com/gmail/v1/users/me/messages?q=after:\${new Date().toISOString().split('T')[0].replace(/-/g,'/')}&maxResults=1\`, { headers: { Authorization: \`Bearer \${token}\` } }).then(r => r.json()),
      fetch('https://gmail.googleapis.com/gmail/v1/users/me/messages?q=is:starred&maxResults=1', { headers: { Authorization: \`Bearer \${token}\` } }).then(r => r.json())
    ]);

    await telegramAPI(env.BOT_TOKEN, 'deleteMessage', { chat_id: chatId, message_id: loadingMsg.result.message_id });

    let text = \`ğŸ“Š *é‚®ç®±ç»Ÿè®¡*\\n\${'â”€'.repeat(24)}\\n\\n\`;
    text += \`ğŸ“§ \${profile.emailAddress || 'N/A'}\\n\\n\`;
    text += \`ğŸ“¬ æœªè¯»: *\${unread.resultSizeEstimate || 0}* å°\\n\`;
    text += \`ğŸ“… ä»Šæ—¥: *\${today.resultSizeEstimate || 0}* å°\\n\`;
    text += \`â­ æ˜Ÿæ ‡: *\${starred.resultSizeEstimate || 0}* å°\\n\`;
    text += \`ğŸ’¾ æ€»è®¡: *\${profile.messagesTotal || 'N/A'}* å°\\n\`;

    const keyboard = {
      inline_keyboard: [
        [
          { text: 'ğŸ“¬ æŸ¥çœ‹æœªè¯»', callback_data: 'action:new' },
          { text: 'ğŸ“… ä»Šæ—¥é‚®ä»¶', callback_data: 'action:today' }
        ],
        [
          { text: 'ğŸ”„ åˆ·æ–°', callback_data: 'action:stats' }
        ]
      ]
    };

    await telegramAPI(env.BOT_TOKEN, 'sendMessage', {
      chat_id: chatId,
      text,
      parse_mode: 'Markdown',
      reply_markup: keyboard
    });
  } catch (error) {
    await telegramAPI(env.BOT_TOKEN, 'deleteMessage', { chat_id: chatId, message_id: loadingMsg.result.message_id }).catch(() => {});
    await sendMessage(chatId, \`âŒ è·å–å¤±è´¥: \${error.message}\`, env);
  }
}

// ==================== å›è°ƒå¤„ç† ====================
async function handleCallbackQuery(query, env, origin) {
  const chatId = query.message.chat.id;
  const userId = query.from.id.toString();
  const data = query.data;
  const messageId = query.message.message_id;

  // åŠ¨ä½œæŒ‰é’®
  if (data.startsWith('action:')) {
    const action = data.split(':')[1];
    await telegramAPI(env.BOT_TOKEN, 'answerCallbackQuery', { callback_query_id: query.id });
    
    switch (action) {
      case 'login':
        const savedOrigin = await env.USER_TOKENS.get('worker_origin') || origin;
        await sendLoginLink(chatId, userId, savedOrigin, env);
        break;
      case 'new':
        await handleMailList(chatId, userId, 'is:unread', null, null, env);
        break;
      case 'today':
        const today = new Date().toISOString().split('T')[0].replace(/-/g, '/');
        await handleMailList(chatId, userId, \`after:\${today}\`, null, null, env);
        break;
      case 'stats':
        await handleStats(chatId, userId, env);
        break;
      case 'search_help':
        await sendSearchHelp(chatId, env);
        break;
      case 'logout':
        await handleLogout(chatId, userId, env);
        break;
      case 'menu':
        await sendWelcome(chatId, env);
        break;
      case 'back':
        await handleMailList(chatId, userId, 'is:unread', null, messageId, env);
        break;
    }
    return;
  }

  // è·å– Token
  const tokenData = await getValidToken(userId, env);
  if (!tokenData) {
    await telegramAPI(env.BOT_TOKEN, 'answerCallbackQuery', {
      callback_query_id: query.id,
      text: 'è¯·å…ˆ /login ç™»å½•',
      show_alert: true
    });
    return;
  }

  // æŸ¥çœ‹é‚®ä»¶è¯¦æƒ…
  if (data.startsWith('mail:')) {
    const mailId = data.split(':')[1];
    await telegramAPI(env.BOT_TOKEN, 'answerCallbackQuery', { callback_query_id: query.id, text: 'åŠ è½½ä¸­...' });
    await sendMailDetail(chatId, mailId, tokenData.access_token, env, messageId);
    return;
  }

  // é‚®ä»¶åˆ—è¡¨ï¼ˆåˆ·æ–°/é¦–é¡µï¼‰
  if (data.startsWith('list:')) {
    const q = data.substring(5);
    await telegramAPI(env.BOT_TOKEN, 'answerCallbackQuery', { callback_query_id: query.id });
    await handleMailList(chatId, userId, q, null, messageId, env);
    return;
  }

  // æœç´¢
  if (data.startsWith('search:')) {
    const q = data.substring(7);
    await telegramAPI(env.BOT_TOKEN, 'answerCallbackQuery', { callback_query_id: query.id });
    await handleMailList(chatId, userId, q, null, null, env);
    return;
  }

  // ä¸‹ä¸€é¡µ
  if (data.startsWith('page:')) {
    const pageId = data.split(':')[1];
    const pageData = await env.USER_TOKENS.get(\`page:\${userId}:\${pageId}\`);
    if (pageData) {
      const { query: q, token } = JSON.parse(pageData);
      await telegramAPI(env.BOT_TOKEN, 'answerCallbackQuery', { callback_query_id: query.id });
      await handleMailList(chatId, userId, q, token, messageId, env);
    } else {
      await telegramAPI(env.BOT_TOKEN, 'answerCallbackQuery', { callback_query_id: query.id, text: 'é¡µé¢å·²è¿‡æœŸ', show_alert: true });
    }
    return;
  }

  // æ ‡è®°å·²è¯»
  if (data.startsWith('read:')) {
    const mailId = data.split(':')[1];
    await fetch(\`https://gmail.googleapis.com/gmail/v1/users/me/messages/\${mailId}/modify\`, {
      method: 'POST',
      headers: { Authorization: \`Bearer \${tokenData.access_token}\`, 'Content-Type': 'application/json' },
      body: JSON.stringify({ removeLabelIds: ['UNREAD'] })
    });
    await telegramAPI(env.BOT_TOKEN, 'answerCallbackQuery', { callback_query_id: query.id, text: 'âœ… å·²æ ‡è®°å·²è¯»' });
    await sendMailDetail(chatId, mailId, tokenData.access_token, env, messageId);
    return;
  }

  // æ ‡è®°æœªè¯»
  if (data.startsWith('unread:')) {
    const mailId = data.split(':')[1];
    await fetch(\`https://gmail.googleapis.com/gmail/v1/users/me/messages/\${mailId}/modify\`, {
      method: 'POST',
      headers: { Authorization: \`Bearer \${tokenData.access_token}\`, 'Content-Type': 'application/json' },
      body: JSON.stringify({ addLabelIds: ['UNREAD'] })
    });
    await telegramAPI(env.BOT_TOKEN, 'answerCallbackQuery', { callback_query_id: query.id, text: 'ğŸ“© å·²æ ‡è®°æœªè¯»' });
    await sendMailDetail(chatId, mailId, tokenData.access_token, env, messageId);
    return;
  }

  // åŠ æ˜Ÿæ ‡
  if (data.startsWith('star:')) {
    const mailId = data.split(':')[1];
    await fetch(\`https://gmail.googleapis.com/gmail/v1/users/me/messages/\${mailId}/modify\`, {
      method: 'POST',
      headers: { Authorization: \`Bearer \${tokenData.access_token}\`, 'Content-Type': 'application/json' },
      body: JSON.stringify({ addLabelIds: ['STARRED'] })
    });
    await telegramAPI(env.BOT_TOKEN, 'answerCallbackQuery', { callback_query_id: query.id, text: 'â­ å·²åŠ æ˜Ÿæ ‡' });
    return;
  }

  // åˆ é™¤é‚®ä»¶
  if (data.startsWith('delete:')) {
    const mailId = data.split(':')[1];
    await fetch(\`https://gmail.googleapis.com/gmail/v1/users/me/messages/\${mailId}/trash\`, {
      method: 'POST',
      headers: { Authorization: \`Bearer \${tokenData.access_token}\` }
    });
    await telegramAPI(env.BOT_TOKEN, 'editMessageText', {
      chat_id: chatId,
      message_id: messageId,
      text: 'ğŸ—‘ï¸ é‚®ä»¶å·²åˆ é™¤',
      reply_markup: { inline_keyboard: [[{ text: 'â¬…ï¸ è¿”å›åˆ—è¡¨', callback_data: 'action:back' }]] }
    });
    await telegramAPI(env.BOT_TOKEN, 'answerCallbackQuery', { callback_query_id: query.id, text: 'ğŸ—‘ï¸ å·²åˆ é™¤' });
    return;
  }

  // ä¸‹è½½é™„ä»¶
  if (data.startsWith('attach:')) {
    const [, mailId, idx] = data.split(':');
    await telegramAPI(env.BOT_TOKEN, 'answerCallbackQuery', { callback_query_id: query.id, text: 'ğŸ“ ä¸‹è½½ä¸­...' });
    
    try {
      const mailResp = await fetch(\`https://gmail.googleapis.com/gmail/v1/users/me/messages/\${mailId}?format=full\`, {
        headers: { Authorization: \`Bearer \${tokenData.access_token}\` }
      });
      const mail = await mailResp.json();
      const attachments = detectAttachments(mail.payload);
      const att = attachments[parseInt(idx)];
      
      if (!att) throw new Error('é™„ä»¶ä¸å­˜åœ¨');
      if (att.size > MAX_ATTACHMENT_SIZE) throw new Error('é™„ä»¶è¶…è¿‡ 15MB é™åˆ¶');

      const attResp = await fetch(\`https://gmail.googleapis.com/gmail/v1/users/me/messages/\${mailId}/attachments/\${att.attachmentId}\`, {
        headers: { Authorization: \`Bearer \${tokenData.access_token}\` }
      });
      const attData = await attResp.json();
      
      const base64 = attData.data.replace(/-/g, '+').replace(/_/g, '/');
      const binary = atob(base64);
      const bytes = new Uint8Array(binary.length);
      for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);

      const formData = new FormData();
      formData.append('chat_id', chatId);
      formData.append('document', new Blob([bytes], { type: att.mimeType }), att.name);
      formData.append('caption', \`ğŸ“ \${att.name}\\nğŸ“ \${(att.size/1024).toFixed(1)} KB\`);

      await fetch(\`https://api.telegram.org/bot\${env.BOT_TOKEN}/sendDocument\`, { method: 'POST', body: formData });
    } catch (e) {
      await sendMessage(chatId, \`âŒ ä¸‹è½½å¤±è´¥: \${e.message}\`, env);
    }
    return;
  }
}

// ==================== å·¥å…·å‡½æ•° ====================
async function getValidToken(userId, env) {
  const raw = await env.USER_TOKENS.get(\`token:\${userId}\`);
  if (!raw) return null;

  let tokenData;
  try { tokenData = JSON.parse(raw); } catch { return null; }

  if (Date.now() > tokenData.expiry - TOKEN_REFRESH_BUFFER) {
    if (!tokenData.refresh_token) return null;
    try {
      const resp = await fetch('https://oauth2.googleapis.com/token', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({
          client_id: env.GOOGLE_CLIENT_ID,
          client_secret: env.GOOGLE_CLIENT_SECRET,
          refresh_token: tokenData.refresh_token,
          grant_type: 'refresh_token'
        })
      });
      const newToken = await resp.json();
      if (!newToken.access_token) return null;
      tokenData.access_token = newToken.access_token;
      tokenData.expiry = Date.now() + (newToken.expires_in * 1000);
      await env.USER_TOKENS.put(\`token:\${userId}\`, JSON.stringify(tokenData));
    } catch { return null; }
  }
  return tokenData;
}

function extractEmailContent(payload) {
  let bodyData = null;

  function findPart(part, mimeType) {
    if (part.mimeType === mimeType && part.body?.data) return part.body.data;
    if (part.parts) {
      for (const p of part.parts) {
        const result = findPart(p, mimeType);
        if (result) return result;
      }
    }
    return null;
  }

  bodyData = findPart(payload, 'text/plain') || findPart(payload, 'text/html') || payload.body?.data;
  if (!bodyData) return '(æ— å†…å®¹)';

  try {
    const base64 = bodyData.replace(/-/g, '+').replace(/_/g, '/');
    const binary = atob(base64);
    const bytes = new Uint8Array(binary.length);
    for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
    let text = new TextDecoder('utf-8').decode(bytes);
    
    // æ¸…ç† HTML
    text = text.replace(/<style[^>]*>[\\s\\S]*?<\\/style>/gi, '');
    text = text.replace(/<script[^>]*>[\\s\\S]*?<\\/script>/gi, '');
    text = text.replace(/<br\\s*\\/?>/gi, '\\n');
    text = text.replace(/<\\/p>/gi, '\\n');
    text = text.replace(/<\\/div>/gi, '\\n');
    text = text.replace(/<[^>]*>/g, '');
    text = text.replace(/&nbsp;/gi, ' ');
    text = text.replace(/&amp;/gi, '&');
    text = text.replace(/&lt;/gi, '<');
    text = text.replace(/&gt;/gi, '>');
    text = text.replace(/[ \\t]+/g, ' ');
    text = text.replace(/\\n\\s*\\n/g, '\\n\\n');
    text = text.trim();
    
    if (text.length > MAX_CONTENT_LENGTH) {
      text = text.substring(0, MAX_CONTENT_LENGTH) + '\\n\\n... (å·²æˆªæ–­)';
    }
    return text || '(æ— å†…å®¹)';
  } catch { return '(è§£æå¤±è´¥)'; }
}

function detectAttachments(payload) {
  const attachments = [];
  function scan(part) {
    if (part.filename && part.body?.attachmentId) {
      attachments.push({
        name: part.filename,
        mimeType: part.mimeType,
        size: part.body.size || 0,
        attachmentId: part.body.attachmentId
      });
    }
    if (part.parts) part.parts.forEach(scan);
  }
  scan(payload);
  return attachments;
}

async function telegramAPI(token, method, params = {}) {
  const resp = await fetch(\`https://api.telegram.org/bot\${token}/\${method}\`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(params)
  });
  return resp.json();
}

async function sendMessage(chatId, text, env, parseMode = null) {
  const params = { chat_id: chatId, text };
  if (parseMode) params.parse_mode = parseMode;
  return telegramAPI(env.BOT_TOKEN, 'sendMessage', params);
}

function jsonResponse(data, status = 200) {
  return new Response(JSON.stringify(data), { status, headers: { 'Content-Type': 'application/json' } });
}

function generateHomePage() {
  return \`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Gmail Bot</title>
<style>body{font-family:system-ui;background:#1a1a2e;color:#fff;display:flex;align-items:center;justify-content:center;min-height:100vh;margin:0}
.c{text-align:center}.e{font-size:4rem;margin-bottom:1rem}h1{font-size:2.5rem}p{color:#94a3b8}.s{background:#22c55e20;border:1px solid #22c55e50;padding:12px 24px;border-radius:50px;margin-top:2rem;display:inline-block}</style>
</head><body><div class="c"><div class="e">ğŸ“§ğŸ¤–</div><h1>Gmail Bot</h1><p>Telegram Bot è¿è¡Œä¸­</p><div class="s">âœ… æœåŠ¡æ­£å¸¸</div></div></body></html>\`;
}`;

    // å¡«å……ä»£ç 
    document.getElementById('workerCode').textContent = workerCode;
    if (typeof Prism !== 'undefined') Prism.highlightAll();

    // å¤åˆ¶åŠŸèƒ½
    document.getElementById('copyBtn').addEventListener('click', async () => {
      const btn = document.getElementById('copyBtn');
      const icon = document.getElementById('copyIcon');
      const text = document.getElementById('copyText');
      
      try {
        await navigator.clipboard.writeText(workerCode);
        icon.textContent = 'âœ…';
        text.textContent = 'å·²å¤åˆ¶!';
        btn.classList.add('bg-green-600');
        btn.classList.remove('bg-purple-600');
        setTimeout(() => {
          icon.textContent = 'ğŸ“‹';
          text.textContent = 'å¤åˆ¶ä»£ç ';
          btn.classList.remove('bg-green-600');
          btn.classList.add('bg-purple-600');
        }, 2000);
      } catch {
        const ta = document.createElement('textarea');
        ta.value = workerCode;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
        icon.textContent = 'âœ…';
        text.textContent = 'å·²å¤åˆ¶!';
      }
    });
  </script>
</body>
</html>
